<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Residual Pro ‚Äî By Ricardo</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0e1a">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #050810;
    --bg-secondary: #0a0e1a;
    --card: rgba(255, 255, 255, 0.02);
    --card-hover: rgba(255, 255, 255, 0.05);
    --text: #e8edf5;
    --text-primary: #ffffff;
    --muted: #7c8ba1;
    --border: rgba(255, 255, 255, 0.06);
    --border-hover: rgba(59, 130, 246, 0.3);
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --accent-glow: rgba(59, 130, 246, 0.4);
    --success: #10b981;
    --success-glow: rgba(16, 185, 129, 0.3);
    --danger: #ef4444;
    --warning: #f59e0b;
    --purple: #8b5cf6;
    --purple-glow: rgba(139, 92, 246, 0.3);
    --radius: 20px;
    --radius-sm: 12px;
    --shadow: 0 20px 60px rgba(0,0,0,0.6);
    --shadow-lg: 0 30px 80px rgba(0,0,0,0.8);
    --glow: 0 0 40px var(--accent-glow);
    --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  [data-theme="light"]{
    --bg: #f5f7fa;
    --bg-secondary: #ffffff;
    --card: #ffffff;
    --card-hover: #f8fafc;
    --text: #1e293b;
    --text-primary: #0f172a;
    --muted: #64748b;
    --border: #e2e8f0;
    --border-hover: rgba(59, 130, 246, 0.4);
    --shadow: 0 10px 40px rgba(15,23,42,0.1);
    --shadow-lg: 0 20px 60px rgba(15,23,42,0.15);
    --glow: 0 0 40px rgba(59, 130, 246, 0.15);
    --accent-glow: rgba(59, 130, 246, 0.2);
    --success-glow: rgba(16, 185, 129, 0.2);
    --purple-glow: rgba(139, 92, 246, 0.2);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  @keyframes gradientShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }
  @keyframes slideInFromTop { from{transform:translateY(-30px);opacity:0} to{transform:translateY(0);opacity:1} }
  @keyframes fadeInUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
  @keyframes scaleIn { from{transform:scale(.9);opacity:0} to{transform:scale(1);opacity:1} }
  @keyframes shimmer { 0%{background-position:-1000px 0} 100%{background-position:1000px 0} }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }
  @keyframes savePulse { 0%{transform:scale(1)} 50%{transform:scale(1.04)} 100%{transform:scale(1)} }
  html, body{
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    overflow-x: hidden;
  }
  body {
    background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 50%, var(--bg) 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
  }
  .wrap { max-width: 980px; margin: 0 auto; padding: 20px 20px 100px; position: relative; }
  body::before {
    content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 20%, var(--accent-glow) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, var(--purple-glow) 0%, transparent 50%);
    opacity: 0.4; pointer-events: none; z-index: 0; animation: float 20s ease-in-out infinite;
  }
  body::after { content: ''; position: fixed; inset: 0; background: linear-gradient(90deg, transparent 0%, rgba(59, 130, 246, 0.03) 50%, transparent 100%); pointer-events: none; z-index: 0; }
  .wrap > * { position: relative; z-index: 1; }
  .top { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%);
    background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px 20px; margin-bottom: 24px; box-shadow: var(--shadow); animation: slideInFromTop 0.6s ease; }
  [data-theme="light"] .top { background: rgba(255,255,255,0.8); }
  .brand { display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .leftRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .pill{
    display:inline-flex; align-items:center; gap:12px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
    background-size:200% 200%; animation: gradientShift 8s ease infinite;
    color:#fff; padding:12px 24px; border-radius:999px; font-weight:900; font-size:.95rem; letter-spacing:.5px;
    box-shadow:0 8px 30px var(--accent-glow); white-space:nowrap; transition:var(--transition); position:relative; overflow:hidden;
  }
  .pill::before{ content:''; position:absolute; inset:0; left:-100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent); animation:shimmer 3s infinite; }
  .pill:hover{ transform:translateY(-3px) scale(1.05); box-shadow:0 12px 40px var(--accent-glow); }
  .theme,.btn{
    border:1px solid var(--border); background:var(--card); backdrop-filter:blur(10px);
    color:var(--text); padding:10px 18px; border-radius:var(--radius-sm); cursor:pointer;
    font-weight:600; font-size:.9rem; transition:var(--transition); white-space:nowrap; font-family:'Inter',sans-serif; position:relative; overflow:hidden;
  }
  .theme::before,.btn::before{ content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:var(--accent-glow); transform:translate(-50%,-50%); transition:width .6s, height .6s; }
  .theme:hover::before,.btn:hover::before{ width:300px; height:300px; }
  .theme:hover,.btn:hover{ background:var(--card-hover); border-color:var(--border-hover); transform:translateY(-2px); box-shadow:0 8px 25px var(--accent-glow); }
  .select{ min-width:200px; transition:var(--transition); }
  .select:hover{ transform:scale(1.02); }
  .card{
    background:var(--card); backdrop-filter:blur(30px) saturate(180%); -webkit-backdrop-filter:blur(30px) saturate(180%);
    border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:28px; transition:var(--transition); animation:fadeInUp .6s ease; position:relative; overflow:hidden;
  }
  .card::before{ content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,var(--accent),transparent); opacity:0; transition:opacity .4s; }
  .card:hover{ border-color:var(--border-hover); box-shadow:var(--shadow-lg), var(--glow); transform:translateY(-5px); }
  .card:hover::before{ opacity:1; }
  .controls{ position:sticky; top:100px; z-index:20; animation-delay:.2s; }
  @media (max-width:900px){ .controls{ position:static; } }
  .grid{ display:grid; gap:18px; }
  .g4{ grid-template-columns:repeat(4,minmax(0,1fr)); }
  .g3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
  .g2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  @media (max-width:900px){ .g4,.g3,.g2{ grid-template-columns:1fr; } }
  label{ font-size:.75rem; color:var(--muted); display:block; margin:0 0 10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; transition:var(--transition); }
  .form-group:hover label{ color:var(--accent); }
  select,input[type="number"],input[type="text"]{
    width:100%; appearance:none; -webkit-appearance:none; background:var(--bg-secondary);
    color:var(--text); border:2px solid var(--border); border-radius:var(--radius-sm);
    padding:14px 18px; font-size:.95rem; font-weight:500; transition:var(--transition); font-family:'Inter',sans-serif;
  }
  select:focus,input:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 4px var(--accent-glow); background:var(--card); transform:translateY(-2px); }
  select:hover,input:hover{ border-color:var(--border-hover); }
  select{
    cursor:pointer;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:right 14px center; padding-right:45px;
  }
  input[type="checkbox"]{ width:24px; height:24px; cursor:pointer; accent-color:var(--accent); transition:var(--transition); }
  input[type="checkbox"]:hover{ transform:scale(1.1); }
  .muted{ color:var(--muted); }
  .hint{ font-size:.8rem; color:var(--muted); margin-top:8px; font-weight:500; font-style:italic; }
  .searchWrap{ max-width:280px; min-width:220px; }
  .rowline{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .result{
    display:flex; align-items:baseline; gap:20px; margin:24px 0 20px; flex-wrap:wrap; padding:32px;
    background:linear-gradient(135deg, var(--accent-glow) 0%, var(--purple-glow) 100%);
    border-radius:var(--radius); border:2px solid var(--border-hover); position:relative; overflow:hidden; animation:scaleIn .6s ease;
  }
  .result::before{ content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%;
    background:linear-gradient(45deg, transparent, rgba(255,255,255,0.05), transparent); animation:shimmer 3s infinite; }
  .result .big{
    font-size:4rem; font-weight:900; letter-spacing:-1px;
    background:linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    position:relative; z-index:1; text-shadow:0 0 40px var(--accent-glow);
  }
  .result .small{ font-size:1.1rem; font-weight:600; position:relative; z-index:1; }
  .tableWrap{ margin-top:20px; overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg-secondary); box-shadow:inset 0 2px 10px rgba(0,0,0,0.1); }
  table{ min-width:720px; width:100%; border-collapse:separate; border-spacing:0; }
  th,td{ padding:16px 20px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap; transition:var(--transition); }
  thead th{
    font-size:.75rem; color:var(--muted); font-weight:800; position:sticky; top:0;
    background:var(--card); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); z-index:1;
    text-transform:uppercase; letter-spacing:1px; border-bottom:2px solid var(--border-hover);
  }
  tbody tr{ transition:var(--transition); }
  tbody tr:hover{ background:var(--card-hover); transform:scale(1.01); }
  td.ok{ color:var(--success); font-weight:800; font-variant-numeric:tabular-nums; text-shadow:0 0 10px var(--success-glow); }
  td.err{ color:var(--danger); opacity:.5; }
  td:first-child,th:first-child{ position:sticky; left:0; background:var(--card); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); z-index:2; font-weight:800; }
  .summary{
    margin-top:24px; padding:32px; border:2px solid var(--border-hover); border-radius:var(--radius);
    background:var(--card); backdrop-filter:blur(30px); box-shadow:var(--shadow-lg);
    animation:scaleIn .8s ease; animation-delay:.3s; animation-fill-mode:both;
  }
  .sum-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; margin-top:20px; }
  @media (max-width:700px){ .sum-grid{ grid-template-columns:1fr; } }
  .srow{
    display:flex; gap:16px; align-items:center; justify-content:space-between;
    background:linear-gradient(135deg, rgba(59,130,246,0.05), rgba(139,92,246,0.05));
    border:1px solid var(--border); border-radius:var(--radius-sm); padding:16px 20px; transition:var(--transition); position:relative; overflow:hidden;
  }
  .srow::before{ content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:linear-gradient(180deg, var(--accent), var(--purple)); transform:scaleY(0); transition:transform .4s; }
  .srow:hover::before{ transform:scaleY(1); }
  .srow:hover{ transform:translateX(8px); border-color:var(--border-hover); box-shadow:0 8px 25px var(--accent-glow);
    background:linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1)); }
  .slabel{ font-weight:700; color:var(--muted); font-size:.9rem; letter-spacing:.5px; }
  .sval{ font-variant-numeric:tabular-nums; font-weight:800; font-size:1.1rem; color:var(--text-primary); }
  .rv-label{ color:#bfa7ff; font-family:inherit; font-weight:700; letter-spacing:.02em; }
  .rv-value{ font-family:inherit; font-weight:800; color:var(--text-primary); }
  .badges{ display:flex; gap:12px; flex-wrap:wrap; margin-top:20px; }
  .badge{
    background:linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.1));
    border:1px solid var(--border-hover); padding:10px 20px; border-radius:999px; font-size:.85rem; font-weight:700; transition:var(--transition); animation:fadeInUp .8s ease; letter-spacing:.3px;
  }
  .badge:hover{ transform:translateY(-3px) scale(1.05); box-shadow:0 8px 20px var(--accent-glow);
    background:linear-gradient(135deg, rgba(59,130,246,0.3), rgba(139,92,246,0.2)); }
  .footer{ margin:40px 0 20px; animation:fadeInUp 1s ease; }
  .foot-card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:28px 32px; text-align:center; }
  .foot-title{
    font-weight:900; letter-spacing:.5px; margin-bottom:12px; font-size:1.2rem;
    background:linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  }
  .foot-text{ color:var(--muted); font-size:.95rem; line-height:1.8; }

  /* Sniffer styles (cards + savings pulse) */
  .snifferWrap { margin-top:18px; display:grid; gap:14px; grid-template-columns: 1fr; }
  .sniffCard { border:1px solid var(--border); border-radius: var(--radius-sm); padding:16px; background:var(--bg-secondary); cursor:pointer; transition:var(--transition); }
  .sniffCard:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,.08); border-color: var(--border-hover); }
  .sniffTop { display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
  .sniffTerm { font-weight:800; font-size:1.05rem; }
  .sniffLVI { font-weight:700; color:var(--muted); }
  .sniffPay { font-weight:800; }
  .sniffSave { font-weight:900; }
  .save-green { color: var(--success); animation: savePulse .8s ease; }
  .save-red { color: var(--danger); animation: savePulse .8s ease; }

  @media (max-width:768px){
    .result .big{ font-size:2.5rem; }
    .card{ padding:20px; }
    .summary{ padding:20px; }
  }
  @media (max-width:375px){
    /* tighter on small iPhones */
    .card{ padding:16px; border-radius: 14px; }
    .srow{ padding:12px 14px; border-radius: 10px; }
    .grid{ gap:12px; }
    .sniffCard{ padding:12px; border-radius:10px; }
    /* stack the two monthly rows vertically */
    #preWithStack{ display:flex; flex-direction:column; gap:10px; }
  }
  @media print{
    body{ background:#fff; }
    .top,.controls,.tableWrap,#leaseCard,.footer,#validatorCard{ display:none !important; }
    .summary{ border:0; box-shadow:none; }
  }
  .loading{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:1.2rem; color:var(--accent); font-weight:700; animation:pulse 1.5s infinite; }
  .success-flash{ animation:successPulse .6s ease; }
  @keyframes successPulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.05); box-shadow:0 0 30px var(--success-glow)} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="leftRow">
          <div class="pill">‚ö° Residual Pro ‚Äî By Ricardo</div>
          <select id="programSel" class="select" title="Choose data source">
            <option value="#embedded" selected>Program: Embedded PB 25-10R (Fallback)</option>
            <option value="porsche_residuals_all.json">Program: PB 25-10R (External)</option>
            <option value="porsche_residuals_25-09R.json">Program: PB 25-09R (Oct, External)</option>
          </select>
        </div>
        <div class="leftRow">
          <button id="jumpSummaryBtn" class="btn" type="button" title="Scroll to Summary">üìä Summary</button>
          <button id="validateBtn" class="btn" type="button" title="Validate loaded JSON">‚úì Validate</button>
          <button id="exportCsvBtn" class="btn" type="button" title="Export table as CSV">üì• Export</button>
          <button id="printBtn" class="btn" type="button" title="Print summary">üñ®Ô∏è Print</button>
          <button id="themeBtn" class="theme" type="button">üåô Dark</button>
        </div>
      </div>
    </div>

    <div class="card controls" id="controls">
      <div class="grid g4">
        <div>
          <label>üöó Model Family</label>
          <select id="familySel"></select>
        </div>
        <div>
          <label>üìÖ Model Year</label>
          <select id="yearSel"></select>
        </div>
        <div>
          <label>üéØ Trim</label>
          <select id="trimSel"></select>
          <div class="hint" id="trimCount"></div>
          <div class="hint" id="trimWarn" style="display:none;color:var(--danger);">‚ö†Ô∏è No trims found</div>
        </div>
        <div class="searchWrap">
          <label>üîç Search Trim</label>
          <input id="trimSearch" type="text" placeholder="Type to filter..." />
        </div>
      </div>

      <div class="grid g3" style="margin-top: 16px">
        <div>
          <label>‚è±Ô∏è Term (months)</label>
          <select id="termSel"></select>
        </div>
        <div>
          <label>üìä Miles per Year</label>
          <select id="annualMilesSel"></select>
        </div>
        <div class="rowline" style="margin-top: 32px">
          <label class="rowline" style="gap: 10px;">
            <input id="pacpoToggle" type="checkbox" />
            <span>+2% PACPO</span>
          </label>
          <label class="rowline" style="gap: 10px;">
            <input id="hideNA" type="checkbox" />
            <span>Hide N/A</span>
          </label>
          <div class="pill" id="codeBadge" style="font-size:0.85rem;padding:8px 16px;">Code: ‚Äî</div>
        </div>
      </div>

      <div class="grid g3" style="margin-top: 16px">
        <div>
          <label>üõ£Ô∏è Miles at Inception</label>
          <input id="odoInput" type="number" min="0" step="1" placeholder="e.g., 3,450" />
          <div class="hint">Adjustment shown even at +0%</div>
        </div>
        <div>
          <label>üí∞ MSRP ($)</label>
          <input id="msrpInput" type="number" min="0" step="100" placeholder="e.g., 142,000" />
        </div>
        <div>
          <label>üîó Shareable Link</label>
          <input id="shareLink" type="text" readonly style="font-size:0.85rem;" />
          <div class="hint">Auto-updates ‚Äî copy to share calc</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 20px; animation-delay: 0.4s;">
      <div class="result">
        <div class="big" id="finalOut">‚Äî</div>
        <div class="small muted" id="detailOut">Select options to calculate</div>
        <div class="small" id="trueOut" style="font-weight:800;"></div>
        <div class="small muted" id="lviBadge" style="font-weight:700;"></div>
      </div>

      <div class="tableWrap">
        <table id="residualTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody><tr id="tvalRow"></tr></tbody>
        </table>
      </div>

      <div class="summary" id="summaryBox">
        <div class="rowline" style="justify-content:space-between;">
          <strong style="font-size:1.3rem;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üìã Summary</strong>
          <button id="copyBtn" class="theme btn" type="button">üìÑ Copy</button>
        </div>

        <div class="srow" style="margin-top:16px; border:3px solid var(--accent); box-shadow: var(--glow); background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));">
          <span class="slabel" style="color:var(--accent);font-size:1rem;">Final Residual</span>
          <span class="sval" id="sumFinal" style="font-size:1.8rem;color:var(--accent);font-weight:900;">‚Äî</span>
        </div>

        <div class="sum-grid">
          <div class="srow" style="display:none;">
            <span class="slabel">Program</span><span class="sval" id="sumProgram">‚Äî</span>
          </div>
          <div class="srow"><span class="slabel">Model Year</span><span class="sval" id="sumYear">‚Äî</span></div>
          <div class="srow"><span class="slabel">Family</span><span class="sval" id="sumFamily">‚Äî</span></div>
          <div class="srow"><span class="slabel">Trim</span><span class="sval" id="sumTrim">‚Äî</span></div>
          <div class="srow"><span class="slabel">Term</span><span class="sval" id="sumTerm">‚Äî</span></div>
          <div class="srow"><span class="slabel">Miles/Year</span><span class="sval" id="sumMilesYear">‚Äî</span></div>
          <div class="srow"><span class="slabel">Odometer</span><span class="sval" id="sumOdo">‚Äî</span></div>
          <div class="srow" style="display:none;">
            <span class="slabel">MSRP</span><span class="sval" id="sumMsrp">‚Äî</span>
          </div>
          <div class="srow"><span class="slabel">MSRP √ó RV% </span><span class="sval" id="sumTrue">‚Äî</span></div>
          <div class="srow">
            <span class="slabel">Value Index</span>
            <span class="sval" id="sumLvi" title="Higher is better">‚Äî</span>
          </div>
        </div>
        <div class="hint" id="lviHelp" style="margin-top:12px;text-align:center;">üí° Higher Value Index = Better Deal</div>

        <div class="badges" id="badgeRow" aria-label="Adjustments"></div>
      </div>
    </div>

    <div class="card" id="leaseCard" style="margin-top: 20px; animation-delay: 0.6s;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:16px;">
        <strong style="font-size:1.2rem;background:linear-gradient(135deg,var(--success),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üí≥ Lease Estimator</strong>
        <span class="muted" style="font-size:0.95rem;font-style:italic;">Uses current RV% & term</span>
      </div>

      <div class="grid g3">
        <div>
          <label>üíµ Cap Cost ($)</label>
          <input id="leaseCapCost" type="number" min="0" step="100" placeholder="e.g., 165000" />
          <div class="hint">Selling price before down</div>
        </div>
        <div>
          <label>üìà Money Factor</label>
          <input id="leaseMF" type="number" min="0" step="0.00001" placeholder="e.g., 0.00210" />
          <div class="hint">Decimal format (0.00210)</div>
          <div class="hint" id="mfAprHint"></div>
        </div>
        <div>
          <label>üßæ Tax Rate (%)</label>
          <input id="leaseTax" type="number" min="0" step="0.01" placeholder="e.g., 9.375" />
        </div>
      </div>

      <div class="grid g3" style="margin-top:14px">
        <div>
          <label>üí∏ Cap Reduction ($)</label>
          <input id="leaseCapReduction" type="number" min="0" step="100" placeholder="0" />
          <div class="hint">Cash down (optional)</div>
        </div>
        <div>
          <label>üìù Rolled Fees ($)</label>
          <input id="leaseFees" type="number" min="0" step="25" placeholder="0" />
          <div class="hint">Acq/Doc fees (optional)</div>
        </div>
        <div>
          <label>‚è∞ Term (mo)</label>
          <input id="leaseTerm" type="number" min="12" step="1" placeholder="auto" />
          <div class="hint">Auto-fills from selection; stays editable</div>
        </div>
      </div>

      <div id="preWithStack" class="grid g2" style="margin-top:16px">
        <div class="srow" style="border:2px solid var(--success);"><span class="slabel" style="color:var(--success);">Monthly (Pre-Tax)</span><span class="sval" id="leasePreTax" style="color:var(--success);font-size:1.3rem;">‚Äî</span></div>
        <div class="srow" style="border:2px solid var(--purple);"><span class="slabel" style="color:var(--purple);">Monthly (With Tax)</span><span class="sval" id="leaseWithTax" style="color:var(--purple);font-size:1.3rem;">‚Äî</span></div>
      </div>
    </div>

    <!-- SNIFFER -->
    <div class="card" id="snifferCard" style="margin-top:16px; animation-delay:0.8s;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:10px;">
        <strong style="font-size:1.1rem;">üîé Lease Sniffer</strong>
        <div class="rowline">
          <span class="muted">Rank by:</span>
          <button id="rankPill" class="pill" type="button" title="Toggle ranking priority">LVI ‚ûú Payment</button>
        </div>
      </div>
      <div class="snifferWrap" id="snifferWrap"></div>
    </div>

    <div class="footer">
      <div class="foot-card">
        <div class="foot-title">‚ú® Crafted by Ricardo</div>
        <div class="foot-text">
          ¬© Ricardo. This internal tool is confidential and intended for authorized use only.
          <br>Do not share, copy, or redistribute without written permission.
          <br><strong>Built with precision. Used with trust.</strong>
        </div>
      </div>
    </div>
  </div>

<!-- Embedded JSON fallback (keep format identical to external) -->
<script id="embeddedProgram" type="application/json">
{
  "pacpo_bonus_percent": 2,
  "months": ["24","27","30","36","39","42","48","51"],
  "annual_mileage_adjustments_percent": {
    "miles_per_year": { "2500": 6, "5000": 5, "7500": 4, "10000": 3, "12000": 2, "15000": 0 }
  },
  "mileage_at_inception_adjustments_percent": {
    "MY22": [
      {"miles_range":"0‚Äì999","adj":0},
      {"miles_range":"1000‚Äì2999","adj":-1},
      {"miles_range":"3000‚Äì4999","adj":-2},
      {"miles_range":"5000‚Äì9999","adj":-3}
    ],
    "MY23": [
      {"miles_range":"0‚Äì999","adj":0},
      {"miles_range":"1000‚Äì2999","adj":-1},
      {"miles_range":"3000‚Äì4999","adj":-2},
      {"miles_range":"5000‚Äì9999","adj":-3}
    ]
  },
  "models": {
    "Cayenne": {
      "MY22": {
        "9YBCAYS": { "model": "Cayenne S (MY22)", "residuals": {"24":63,"27":62,"30":61,"36":58,"39":57,"42":56,"48":53,"51":52} },
        "9YBCAYT": { "model": "Cayenne (MY22)",   "residuals": {"24":64,"27":63,"30":62,"36":59,"39":58,"42":57,"48":54,"51":53} }
      },
      "MY23": {
        "9YBCAYU": { "model": "Cayenne S (MY23)", "residuals": {"24":64,"27":63,"30":62,"36":59,"39":58,"42":57,"48":54,"51":53} },
        "9YBCAYV": { "model": "Cayenne (MY23)",   "residuals": {"24":65,"27":64,"30":63,"36":60,"39":59,"42":58,"48":55,"51":54} }
      }
    },
    "911": {
      "MY22": {
        "992C4GTS": { "model": "911 Carrera 4 GTS (MY22)", "residuals": {"24":70,"27":69,"30":68,"36":65,"39":64,"42":63,"48":60,"51":59} }
      },
      "MY23": {
        "992TARGA": { "model": "911 Targa (MY23)", "residuals": {"24":69,"27":68,"30":67,"36":64,"39":63,"42":62,"48":59,"51":58} }
      }
    },
    "Taycan": {
      "MY22": {
        "Y1A": { "model": "Taycan (MY22)", "residuals": {"24":62,"27":61,"30":60,"36":57,"39":56,"42":55,"48":52,"51":51} }
      },
      "MY23": {
        "Y1B": { "model": "Taycan 4S (MY23)", "residuals": {"24":63,"27":62,"30":61,"36":58,"39":57,"42":56,"48":53,"51":52} }
      }
    },
    "Macan": {
      "MY22": {
        "95BMAC": { "model": "Macan (MY22)", "residuals": {"24":66,"27":65,"30":64,"36":61,"39":60,"42":59,"48":56,"51":55} }
      },
      "MY23": {
        "95BMACS": { "model": "Macan S (MY23)", "residuals": {"24":65,"27":64,"30":63,"36":60,"39":59,"42":58,"48":55,"51":54} }
      }
    },
    "Panamera": {
      "MY22": {
        "97APAN": { "model": "Panamera (MY22)", "residuals": {"24":61,"27":60,"30":59,"36":56,"39":55,"42":54,"48":51,"51":50} }
      }
    }
  }
}
</script>

<script>
(function(){
  // Ensure LIGHT mode default
  document.documentElement.setAttribute('data-theme', 'light');

  // DOM refs
  var themeBtn = document.getElementById('themeBtn');
  var programSel = document.getElementById('programSel');
  var validateBtn = document.getElementById('validateBtn');
  var exportCsvBtn = document.getElementById('exportCsvBtn');
  var printBtn = document.getElementById('printBtn');
  var jumpSummaryBtn = document.getElementById('jumpSummaryBtn');
  var familySel = document.getElementById('familySel');
  var yearSel = document.getElementById('yearSel');
  var trimSel = document.getElementById('trimSel');
  var trimSearch = document.getElementById('trimSearch');
  var trimCount = document.getElementById('trimCount');
  var trimWarn = document.getElementById('trimWarn');
  var termSel = document.getElementById('termSel');
  var pacpoToggle = document.getElementById('pacpoToggle');
  var hideNA = document.getElementById('hideNA');
  var codeBadge = document.getElementById('codeBadge');
  var finalOut = document.getElementById('finalOut');
  var detailOut = document.getElementById('detailOut');
  var trueOut = document.getElementById('trueOut');
  var theadRow = document.getElementById('theadRow');
  var tvalRow = document.getElementById('tvalRow');
  var annualMilesSel = document.getElementById('annualMilesSel');
  var odoInput = document.getElementById('odoInput');
  var msrpInput = document.getElementById('msrpInput');
  var shareLink = document.getElementById('shareLink');
  var sumProgram = document.getElementById('sumProgram');
  var sumYear = document.getElementById('sumYear');
  var sumFamily = document.getElementById('sumFamily');
  var sumTrim = document.getElementById('sumTrim');
  var sumTerm = document.getElementById('sumTerm');
  var sumMilesYear = document.getElementById('sumMilesYear');
  var sumOdo = document.getElementById('sumOdo');
  var sumMsrp = document.getElementById('sumMsrp');
  var sumTrue = document.getElementById('sumTrue');
  var sumFinal = document.getElementById('sumFinal');
  var badgeRow = document.getElementById('badgeRow');
  var copyBtn = document.getElementById('copyBtn');
  var leaseCapCost = document.getElementById('leaseCapCost');
  var leaseMF = document.getElementById('leaseMF');
  var leaseTax = document.getElementById('leaseTax');
  var leaseCapReduction = document.getElementById('leaseCapReduction');
  var leaseFees = document.getElementById('leaseFees');
  var leaseTerm = document.getElementById('leaseTerm');
  var leaseRvPct = document.getElementById('leaseRvPct');
  var leaseRvAmt = document.getElementById('leaseRvAmt');
  var leaseAdjCap = document.getElementById('leaseAdjCap');
  var leasePreTax = document.getElementById('leasePreTax');
  var leaseWithTax = document.getElementById('leaseWithTax');
  var mfAprHint = document.getElementById('mfAprHint');
  var lviBadge = document.getElementById('lviBadge');
  var sumLvi = document.getElementById('sumLvi');
  var validatorCard = document.getElementById('validatorCard');
  var validatorOutput = document.getElementById('validatorOutput');
  var rankPill = document.getElementById('rankPill');
  var snifferWrap = document.getElementById('snifferWrap');

  var data, MONTHS = [], PACPO = 2;
  var fullTrimList = [];
  var currentProgramLabel = 'Embedded';
  var rankMode = 'LVI_FIRST'; // or 'PAYMENT_FIRST'
  var lastLeaseCalc = {pre: null, with: null}; // used for savings comparison displayed in sniffer

  // Theme toggle
  themeBtn.innerHTML = 'üåô Dark';
  themeBtn.addEventListener('click', function(){
    var cur = document.documentElement.getAttribute('data-theme');
    var next = (cur === 'light') ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    themeBtn.innerHTML = next === 'light' ? 'üåô Dark' : '‚òÄÔ∏è Light';
    themeBtn.classList.add('success-flash');
    setTimeout(function(){ themeBtn.classList.remove('success-flash'); }, 600);
  });

  // Helpers
  function normalizeYearKey(k){
    var s = String(k).trim();
    var mPlain = s.match(/^(20\\d{2})$/); if (mPlain) return { display: 'MY' + mPlain[1].slice(-2), key: k };
    var mMY = s.toUpperCase().replace(/\\s+/g,'').match(/^MY(\\d{2})$/); if (mMY) return { display: 'MY' + mMY[1], key: k };
    return { display: s, key: k };
  }
  function getCaseInsensitive(obj, name){
    if(!obj || typeof obj !== "object") return undefined;
    var target = String(name).replace(/\\s+/g,'').toLowerCase();
    var keys = Object.keys(obj);
    for(var i=0;i<keys.length;i++){ if(keys[i].replace(/\\s+/g,'').toLowerCase() === target) return obj[keys[i]]; }
    return undefined;
  }
  function getVirtualFamilies(){
    var out = new Set();
    var models = data.models || {};
    Object.keys(models).forEach(function(f){
      if(f === '718'){
        var cay = getCaseInsensitive(models['718'],'Cayman');
        var box = getCaseInsensitive(models['718'],'Boxster');
        if (cay) out.add('718 Cayman'); if (box) out.add('718 Boxster');
      } else { out.add(f); }
    });
    if(models['Cayman']) out.add('718 Cayman');
    if(models['Boxster']) out.add('718 Boxster');
    var order = ['911','718 Cayman','718 Boxster','Taycan','Macan','Cayenne','Panamera'];
    return Array.from(out).sort(function(a,b){ return order.indexOf(a) - order.indexOf(b); });
  }
  function branchForFamily(famDisp){
    var models = data.models || {};
    if (famDisp === '718 Cayman') return getCaseInsensitive(models['718']||{}, 'Cayman') || models['Cayman'] || {};
    if (famDisp === '718 Boxster') return getCaseInsensitive(models['718']||{}, 'Boxster') || models['Boxster'] || {};
    return models[famDisp] || {};
  }
  function yearsForFamily(famDisp){
    var out = new Set(); var branch = branchForFamily(famDisp);
    Object.keys(branch).forEach(function(k){ out.add(normalizeYearKey(k).display); });
    return Array.from(out).sort(function(a,b){
      var ay = parseInt(a.replace(/\\D/g,''),10), by = parseInt(b.replace(/\\D/g,''),10);
      if (isNaN(ay) || isNaN(by)) return b.localeCompare(a);
      return by - ay;
    });
  }
  function populate(select, arr){
    select.innerHTML = '';
    arr.forEach(function(v){ var opt = document.createElement('option'); opt.value = v; opt.textContent = v; select.appendChild(opt); });
  }
  function populateAnnualMiles(){
    annualMilesSel.innerHTML = '';
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {
      "2500":6,"5000":5,"7500":4,"10000":3,"12000":2,"15000":0
    };
    Object.keys(milesMap).map(function(k){ return parseInt(k,10); }).sort(function(a,b){ return a-b; })
      .forEach(function(n){ var opt = document.createElement('option'); opt.value = String(n); opt.textContent = n.toLocaleString() + ' mi/yr'; annualMilesSel.appendChild(opt); });
    annualMilesSel.value = "15000";
  }
  function collectTrimsForYear(){
    fullTrimList = [];
    var branch = branchForFamily(familySel.value);
    var dispYear = yearSel.value;
    var yearKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var rows = (yearKey && branch[yearKey]) || {};
    Object.entries(rows).forEach(function(entry){ fullTrimList.push({code: entry[0], model: entry[1].model || entry[0]}); });
  }
  function populateTrims(filterTerm){
    trimSel.innerHTML = '';
    var term = (filterTerm||'').trim().toLowerCase();
    var filtered = fullTrimList.filter(function(t){ return (t.model + " " + t.code).toLowerCase().indexOf(term) !== -1; });
    filtered.forEach(function(item){ var opt = document.createElement('option'); opt.value = item.code; opt.textContent = item.model; opt.dataset.code = item.code; trimSel.appendChild(opt); });
    trimCount.textContent = filtered.length ? (filtered.length + ' trim(s) available') : 'No matches';
    trimWarn.style.display = filtered.length ? 'none' : 'block';
  }
  function parseRange(str){
    if(!str) return null;
    var s = str.replace(/,/g,'').replace(/\\s/g,'');
    var parts = s.split(/‚Äì|-/); if(parts.length !== 2) return null;
    var a = parseInt(parts[0],10), b = parseInt(parts[1],10);
    if(isNaN(a) || isNaN(b)) return null;
    return [a,b];
  }
  function findInceptionAdj(myKey, odo){
    var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[myKey]) || null;
    if(!bands || odo == null) return 0;
    for(var i=0;i<bands.length;i++){
      var rng = parseRange(bands[i].miles_range); if(!rng) continue;
      if(odo >= rng[0] && odo <= rng[1]) return bands[i].adj || 0;
    }
    return 0;
  }
  function visibleMonthsFor(entry){
    if(!hideNA.checked) return MONTHS.slice();
    var result = [];
    for(var i=0;i<MONTHS.length;i++){ if(entry && entry.residuals && entry.residuals[MONTHS[i]] != null) result.push(MONTHS[i]); }
    return result;
  }
  function buildHeader(visibleMonths){
    theadRow.innerHTML = '';
    var th1 = document.createElement('th'); th1.textContent = 'Trim / Term'; theadRow.appendChild(th1);
    visibleMonths.forEach(function(m){ var th = document.createElement('th'); th.textContent = m + ' mo'; theadRow.appendChild(th); });
  }
  function computeLVI(rvPercent, mf){ if(!isFinite(rvPercent) || !isFinite(mf) || mf <= 0) return null; return rvPercent / mf; }

  function addBadge(txt){
    var b = document.createElement('div'); b.className = 'badge'; b.textContent = txt; badgeRow.appendChild(b);
  }

  function exportVisibleCSV(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    if(!yrKey || !trimSel.value){ alert('Select family/year/trim first.'); return; }
    var entry = branch[yrKey][trimSel.value];
    var monthsShown = visibleMonthsFor(entry);

    var rows = [];
    rows.push(['Trim/Term'].concat(monthsShown.map(function(m){return m + ' mo';})));
    var line = [(entry && entry.model) || '‚Äî'];
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    var pacpoAdj = pacpoToggle.checked ? (data.pacpo_bonus_percent || 2) : 0;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\\s+/g,'')];
    var inceptionAdj = 0;
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    monthsShown.forEach(function(m){
      var v = entry && entry.residuals && entry.residuals[m];
      if(v==null){ line.push(''); return; }
      var aAdj = (parseInt(m,10) >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
      var total = v + pacpoAdj + aAdj + inceptionAdj;
      line.push(total + '%');
    });
    rows.push(line);

    rows.push([]);
    rows.push(['Program', currentProgramLabel]);
    rows.push(['Year', dispYear], ['Family', fam], ['Trim', (entry && entry.model)||'‚Äî'], ['Term', termSel.value ? termSel.value+' mo':'‚Äî']);
    rows.push(['Miles/Year', sumMilesYear.textContent], ['Odometer', sumOdo.textContent], ['Final', sumFinal.textContent]);
    if(msrpInput.value){ rows.push(['MSRP', '$'+Number(msrpInput.value).toLocaleString()], ['MSRP √ó RV%', sumTrue.textContent]); }

    var csv = rows.map(function(r){
      return r.map(function(c){
        var s = (c==null ? '' : String(c));
        if(s.indexOf('"')!=-1 || s.indexOf(',')!=-1) s='"'+s.replace(/"/g,'""')+'"';
        return s;
      }).join(',');
    }).join('\\r\\n');

    var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href = url;
    var safeTrim = ((entry && entry.model)||'trim').replace(/[^\\w\\-]+/g,'_');
    a.download = 'residual_' + safeTrim + '_' + (dispYear||'MY').replace(/\\s+/g,'') + '.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function printSummary(){ window.print(); }
  function validateJSON(){
    if(!data){ alert('Load a program first.'); return; }
    var issues = [];
    var models = data.models || {};
    var totalTrims = 0, missingCells = 0;
    function checkEntry(modelFamily, yearKey, code, entry){
      totalTrims++;
      var resids = entry.residuals || {};
      MONTHS.forEach(function(m){
        if(!(m in resids) || resids[m] == null){
          missingCells++;
          issues.push('Missing ‚Üí ['+modelFamily+'] ['+yearKey+'] ['+(entry.model||code)+'] term '+m+' mo');
        }
      });
    }
    Object.keys(models).forEach(function(fam){
      var famBranch = models[fam];
      if(!famBranch || typeof famBranch!=='object') return;
      Object.keys(famBranch).forEach(function(yearKey){
        var group = famBranch[yearKey];
        if(!group || typeof group!=='object'){ issues.push('Bad year group at '+fam+' / '+yearKey); return; }
        Object.keys(group).forEach(function(code){
          var entry = group[code];
          if(!entry || typeof entry!=='object'){ issues.push('Bad entry at '+fam+' / '+yearKey+' / '+code); return; }
          if(!('model' in entry)) issues.push('No "model" at '+fam+' / '+yearKey+' / '+code);
          if(!('residuals' in entry)) issues.push('No "residuals" at '+fam+' / '+yearKey+' / '+code);
          else checkEntry(fam, yearKey, code, entry);
        });
      });
    });
    if(!data.annual_mileage_adjustments_percent || !data.annual_mileage_adjustments_percent.miles_per_year){ issues.push('annual_mileage_adjustments_percent.miles_per_year missing'); }
    if(!data.mileage_at_inception_adjustments_percent){ issues.push('mileage_at_inception_adjustments_percent missing'); }
    alert((issues.length? 'Issues:\\n- ' + issues.join('\\n- ') : '‚úÖ No issues found!'));
  }

  function compute(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var code = trimSel.value;
    var term = termSel.value;
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;

    if(!yrKey || !code){
      finalOut.textContent = '‚Äî';
      detailOut.textContent = 'Select family/year/trim';
      trueOut.textContent = '';
      if(lviBadge) lviBadge.textContent = '';
      if(sumLvi) sumLvi.textContent = '‚Äî';
      updateShareURL();
      return;
    }

    var entry = branch[yrKey][code];
    var base = term ? ((entry && entry.residuals && entry.residuals[term]) || null) : null;
    PACPO = data.pacpo_bonus_percent || 2;
    var pacpoAdj = pacpoToggle.checked ? PACPO : 0;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var annualAdj = 0;
    if(base !== null && parseInt(term || "0", 10) >= 24){ annualAdj = milesMap[String(milesPerYear)] || 0; }

    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\\s+/g,'')];
    var inceptionAdj = 0;
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    var monthsShown = visibleMonthsFor(entry);
    buildHeader(monthsShown);

    var final = (base === null || term == null) ? null : (base + pacpoAdj + annualAdj + inceptionAdj);
    finalOut.textContent = final === null ? '‚Äî' : final + '%';
    finalOut.classList.add('success-flash');
    setTimeout(function(){ finalOut.classList.remove('success-flash'); }, 600);
    detailOut.textContent = final === null ? 'Select a term' : 'Final with all adjustments';
    codeBadge.textContent = 'Code: ' + (code || '‚Äî');

    tvalRow.innerHTML = '';
    var lead = document.createElement('td'); lead.textContent = (entry && entry.model) || '‚Äî'; tvalRow.appendChild(lead);
    monthsShown.forEach(function(m){
      var td = document.createElement('td');
      var v = entry && entry.residuals && entry.residuals[m];
      var shown = '‚Äî';
      if(v !== null && v !== undefined){
        var mN = parseInt(m, 10);
        var aAdj = (mN >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
        var total = v + pacpoAdj + aAdj + inceptionAdj;
        shown = total + '%'; td.classList.add('ok');
      } else { td.classList.add('err'); }
      td.textContent = shown; tvalRow.appendChild(td);
    });

    sumProgram.textContent = currentProgramLabel;
    sumYear.textContent = dispYear || '‚Äî';
    sumFamily.textContent = fam || '‚Äî';
    sumTrim.textContent = (entry && entry.model) || '‚Äî';
    sumTerm.textContent = term ? (term + ' mo') : '‚Äî';
    sumMilesYear.textContent = Number.isFinite(milesPerYear) ? milesPerYear.toLocaleString() + ' mi/yr' : '‚Äî';
    sumOdo.textContent = (odo != null && !isNaN(odo)) ? odo.toLocaleString() + ' mi' : '‚Äî';

    var msrp = msrpInput.value ? Number(msrpInput.value) : null;
    if (sumMsrp) sumMsrp.textContent = (msrp != null && !isNaN(msrp)) ? ('$' + msrp.toLocaleString()) : '‚Äî';
    var trueResidual = (final != null && msrp != null && !isNaN(msrp)) ? Math.round(msrp * (final/100)) : null;
    sumTrue.textContent = (trueResidual != null) ? ('$' + trueResidual.toLocaleString()) : '‚Äî';
    trueOut.innerHTML = (trueResidual != null)
      ? ('<span class="rv-label">MSRP √ó RV% = </span><span class="rv-value">$' + trueResidual.toLocaleString() + '</span>')
      : '';

    badgeRow.innerHTML = '';
    if(base !== null && term){ addBadge('Base ' + base + '%'); }
    if(pacpoToggle.checked){ addBadge('+' + PACPO + '% PACPO'); }
    if(term && parseInt(term, 10) >= 24){ addBadge(((annualAdj>=0?'+':'') + annualAdj + '%') + ' Annual'); }
    if(odo != null && !isNaN(odo)){ addBadge(((inceptionAdj>=0?'+':'') + inceptionAdj + '%') + ' Inception'); }

    sumFinal.textContent = final === null ? '‚Äî' : final + '%';

    var mfVal = leaseMF && leaseMF.value ? Number(leaseMF.value) : NaN;
    var lviCurrent = computeLVI(final, mfVal);
    if(lviCurrent != null){
      var lviText = (lviCurrent/1000).toFixed(1) + 'k';
      if(lviBadge) lviBadge.textContent = 'LVI: ' + lviText;
      if(sumLvi) sumLvi.textContent = lviText;
    } else {
      if(lviBadge) lviBadge.textContent = '';
      if(sumLvi) sumLvi.textContent = '‚Äî';
    }

    updateShareURL();
    // Auto-fill leaseTerm once, but don't force it afterwards
    if(leaseTerm && (!leaseTerm.value || leaseTerm.value === '')) {
      if(termSel && termSel.value) leaseTerm.value = termSel.value;
    }
    leaseCompute();
    runSniffer(); // auto-run on every change
  }

  function updateShareURL(){
    var p = new URLSearchParams();
    var program = programSel.value;
    p.set('data', program);
    if(familySel.value) p.set('family', familySel.value);
    if(yearSel.value) p.set('year', yearSel.value);
    if(trimSel.value) p.set('trim', trimSel.value);
    if(termSel.value) p.set('term', termSel.value);
    if(annualMilesSel.value) p.set('miles', annualMilesSel.value);
    if(odoInput.value) p.set('odo', odoInput.value);
    if(pacpoToggle.checked) p.set('pacpo', '1');
    if(hideNA.checked) p.set('hidena', '1');
    if(msrpInput.value) p.set('msrp', msrpInput.value);
    var url = location.pathname + '?' + p.toString();
    var full = (location.origin ? (location.origin + url) : url);
    if(shareLink) shareLink.value = full;
    try{ history.replaceState(null, '', url); }catch(e){}
  }

  function leaseCompute(){
    var rvPctText = sumFinal.textContent;
    var rvPct = (rvPctText && rvPctText.endsWith('%')) ? parseFloat(rvPctText) : NaN;
    var msrp = msrpInput.value ? Number(msrpInput.value) : NaN;
    var term = leaseTerm.value ? parseInt(leaseTerm.value, 10)
                               : (termSel && termSel.value ? parseInt(termSel.value,10) : NaN);
    var cap = leaseCapCost.value ? Number(leaseCapCost.value) : NaN;
    var mf = leaseMF.value ? Number(leaseMF.value) : NaN;
    var tax = leaseTax.value ? Number(leaseTax.value)/100 : 0;
    var capRed = leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    var fees = leaseFees.value ? Number(leaseFees.value) : 0;

    leaseRvPct.textContent = isFinite(rvPct) ? (rvPct.toFixed(2) + '%') : '‚Äî';

    if(!isFinite(msrp) || !isFinite(rvPct) || !isFinite(term) || term <= 0){
      leaseRvAmt.textContent = '‚Äî'; leaseAdjCap.textContent = '‚Äî'; leasePreTax.textContent = '‚Äî'; leaseWithTax.textContent = '‚Äî';
      mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }

    var rvAmt = Math.round(msrp * (rvPct/100));
    leaseRvAmt.textContent = '$' + rvAmt.toLocaleString();

    var adjCap = (isFinite(cap) ? cap : 0) - (isFinite(capRed) ? capRed : 0) + (isFinite(fees) ? fees : 0);
    leaseAdjCap.textContent = isFinite(adjCap) ? ('$' + adjCap.toLocaleString()) : '‚Äî';

    if(!isFinite(adjCap) || adjCap <= 0 || !isFinite(mf) || mf <= 0){
      leasePreTax.textContent = '‚Äî'; leaseWithTax.textContent = '‚Äî';
      mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }

    var dep = (adjCap - rvAmt) / term;
    var fin = (adjCap + rvAmt) * mf;
    var preTax = dep + fin;
    var withTax = preTax * (1 + (isFinite(tax) ? tax : 0));

    if(!isFinite(preTax) || preTax < 0){
      leasePreTax.textContent = '‚Äî'; leaseWithTax.textContent = '‚Äî';
      mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }
    leasePreTax.textContent = '$' + Math.round(preTax).toLocaleString();
    leaseWithTax.textContent = '$' + Math.round(withTax).toLocaleString();
    mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';

    // remember for sniffer savings comparisons
    lastLeaseCalc = {pre: Math.round(preTax), with: Math.round(withTax)};
  }

  // Lease Sniffer
  function runSniffer(){
    // Need current scenario context + all terms
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var code = trimSel.value;
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    if(!yrKey || !code) { snifferWrap.innerHTML = ''; return; }
    var entry = branch[yrKey][code];
    var pacpoAdj = pacpoToggle.checked ? (data.pacpo_bonus_percent || 2) : 0;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;

    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\\s+/g,'')];
    var inceptionAdj = 0;
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    var msrp = msrpInput.value ? Number(msrpInput.value) : NaN;
    var cap = leaseCapCost.value ? Number(leaseCapCost.value) : NaN;
    var mf = leaseMF.value ? Number(leaseMF.value) : NaN;
    var tax = leaseTax.value ? Number(leaseTax.value)/100 : 0;
    var capRed = leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    var fees = leaseFees.value ? Number(leaseFees.value) : 0;

    var results = [];
    (MONTHS || []).forEach(function(m){
      var base = (entry && entry.residuals && entry.residuals[m] != null) ? entry.residuals[m] : null;
      if(base == null) return;
      var mN = parseInt(m,10);
      var annualAdj = (mN >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
      var finalPct = base + pacpoAdj + annualAdj + inceptionAdj;

      // Estimate payment with the SAME structure as current
      var rvAmt = (isFinite(msrp) && isFinite(finalPct)) ? Math.round(msrp * (finalPct/100)) : NaN;
      var adjCap = (isFinite(cap) ? cap : 0) - (isFinite(capRed) ? capRed : 0) + (isFinite(fees) ? fees : 0);
      var pre = NaN, withTx = NaN;
      if(isFinite(adjCap) && isFinite(rvAmt) && isFinite(mf) && mf>0){
        var dep = (adjCap - rvAmt) / mN;
        var fin = (adjCap + rvAmt) * mf;
        pre = dep + fin;
        withTx = pre * (1 + (isFinite(tax) ? tax : 0));
      }
      var lvi = computeLVI(finalPct, mf);

      results.push({
        term: mN,
        finalPct: finalPct,
        lvi: lvi,
        pre: isFinite(pre) ? Math.round(pre) : null,
        with: isFinite(withTx) ? Math.round(withTx) : null
      });
    });

    // Ranking
    results = results.filter(function(r){ return r.with != null && r.lvi != null; });

    if(rankMode === 'LVI_FIRST'){
      results.sort(function(a,b){
        if(b.lvi !== a.lvi) return b.lvi - a.lvi; // higher LVI better
        return a.with - b.with; // then lower payment
      });
    } else {
      results.sort(function(a,b){
        if(a.with !== b.with) return a.with - b.with; // lower payment better
        return b.lvi - a.lvi; // then higher LVI
      });
    }

    var topN = results.slice(0,6);
    snifferWrap.innerHTML = '';
    var currentWith = (lastLeaseCalc && lastLeaseCalc.with) ? lastLeaseCalc.with : null;

    topN.forEach(function(r){
      var saveText = '';
      var saveClass = '';
      if(currentWith != null && isFinite(currentWith)){
        var diff = currentWith - r.with;
        if(diff > 0){ saveText = 'Saves $' + diff.toLocaleString() + '/mo vs current'; saveClass = 'save-green'; }
        else if(diff < 0){ saveText = 'Costs $' + Math.abs(diff).toLocaleString() + '/mo vs current'; saveClass = 'save-red'; }
        else { saveText = 'Same as current payment'; }
      } else {
        saveText = '‚Äî';
      }
      var card = document.createElement('div');
      card.className = 'sniffCard';
      card.innerHTML = ''
        + '<div class="sniffTop">'
        + '  <div><div class="sniffTerm">' + r.term + ' mo</div><div class="sniffLVI">LVI ' + (r.lvi ? (r.lvi/1000).toFixed(1)+'k' : '‚Äî') + ' ‚Ä¢ RV ' + r.finalPct.toFixed(2) + '%</div></div>'
        + '  <div class="sniffPay">$' + (r.with != null ? r.with.toLocaleString() : '‚Äî') + ' /mo</div>'
        + '</div>'
        + '<div class="sniffSave ' + saveClass + '" style="margin-top:8px;">' + saveText + '</div>';
      card.addEventListener('click', function(){
        // load picked term into estimator; do NOT lock future manual edits
        if(leaseTerm) leaseTerm.value = String(r.term);
        if(termSel) termSel.value = String(r.term);
        compute(); // recompute using that term
      });
      snifferWrap.appendChild(card);
    });
  }

  // Program loader with robust fallback
  function loadFromEmbedded(){
    try{
      var el = document.getElementById('embeddedProgram');
      if(!el) throw new Error('No embedded program');
      var j = JSON.parse(el.textContent);
      data = j; window.__data = data;
      MONTHS = data.months || ["24","27","30","36","39","42","48","51"];
      PACPO = data.pacpo_bonus_percent || 2;
      currentProgramLabel = 'Embedded PB 25-10R';
      initSelectors();
      compute();
      return true;
    }catch(e){
      alert('Embedded data failed: ' + e.message);
      return false;
    }
  }

  function initSelectors(){
    populate(familySel, getVirtualFamilies());
    populate(yearSel, yearsForFamily(familySel.value));
    termSel.innerHTML = '';
    MONTHS.forEach(function(m){ var opt = document.createElement('option'); opt.value = m; opt.textContent = m + ' months'; termSel.appendChild(opt); });
    populateAnnualMiles();
    collectTrimsForYear();
    populateTrims('');
  }

  function restoreFromParams(){
    var p = new URLSearchParams(location.search);
    var prog = p.get('data');
    if(prog && prog !== '#embedded'){ programSel.value = prog; } else { programSel.value = '#embedded'; }
    var fam = p.get('family'); if(fam) familySel.value = fam;
    populate(yearSel, yearsForFamily(familySel.value));
    var year = p.get('year'); if(year && Array.from(yearSel.options).some(function(o){return o.value===year;})){ yearSel.value = year; }
    collectTrimsForYear(); populateTrims('');
    var trim = p.get('trim'); if(trim && Array.from(trimSel.options).some(function(o){return o.value===trim;})){ trimSel.value = trim; }
    var term = p.get('term'); if(term && Array.from(termSel.options).some(function(o){return o.value===term;})){ termSel.value = term; }
    var miles = p.get('miles'); if(miles) annualMilesSel.value = miles;
    var odo = p.get('odo'); if(odo) odoInput.value = odo;
    var pac = p.get('pacpo'); pacpoToggle.checked = (pac === '1');
    var hn = p.get('hidena'); hideNA.checked = (hn === '1');
    var ms = p.get('msrp'); if(ms) msrpInput.value = ms;
  }

  function loadProgram(file, label){
    if(file === '#embedded'){
      var ok = loadFromEmbedded();
      if(ok){ sumProgram.textContent = label || 'Embedded'; updateShareURL(); compute(); }
      return Promise.resolve();
    }
    var target = file;
    var cacheBuster = 't=' + Date.now();
    return fetch(target + '?' + cacheBuster, {cache:'no-store'}).then(function(res){
      if(!res.ok) throw new Error('HTTP ' + res.status + ' loading ' + target);
      return res.json();
    }).then(function(j){
      data = j; window.__data = data;
      MONTHS = data.months || ["24","27","30","36","39","42","48","51"];
      PACPO = data.pacpo_bonus_percent || 2;
      currentProgramLabel = label || target;
      sumProgram.textContent = currentProgramLabel;
      initSelectors();
      restoreFromParams();
      compute();
      updateShareURL();
    }).catch(function(err){
      alert('Could not load "'+target+'". Falling back to embedded data.\\n\\n' + err.message);
      programSel.value = '#embedded';
      loadFromEmbedded();
      restoreFromParams();
      compute();
      updateShareURL();
    });
  }

  // Events
  programSel.addEventListener('change', function(){
    var label = programSel.options[programSel.selectedIndex].textContent.replace(/^Program:\\s*/,'').trim();
    loadProgram(programSel.value, label);
  });
  jumpSummaryBtn.addEventListener('click', function(){
    var el = document.getElementById('summaryBox');
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); el.classList.add('success-flash'); setTimeout(function(){ el.classList.remove('success-flash'); }, 600); }
  });
  familySel.addEventListener('change', function(){ populate(yearSel, yearsForFamily(familySel.value)); collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  yearSel.addEventListener('change', function(){ collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  trimSearch.addEventListener('input', function(){ populateTrims(trimSearch.value); compute(); });
  trimSel.addEventListener('change', compute);
  termSel.addEventListener('change', function(){ compute(); if(leaseTerm && (!leaseTerm.value || leaseTerm.value==='')) leaseTerm.value = termSel.value; });
  pacpoToggle.addEventListener('change', compute);
  hideNA.addEventListener('change', compute);
  annualMilesSel.addEventListener('change', compute);
  odoInput.addEventListener('input', compute);
  msrpInput.addEventListener('input', compute);
  copyBtn.addEventListener('click', function(){
    var parts = [
      'Program: ' + (sumProgram ? sumProgram.textContent : '‚Äî'),
      'Year: ' + sumYear.textContent,
      'Family: ' + sumFamily.textContent,
      'Trim: ' + sumTrim.textContent,
      'Term: ' + sumTerm.textContent,
      'Miles/Year: ' + sumMilesYear.textContent,
      'Odometer: ' + sumOdo.textContent,
      (sumMsrp ? ('MSRP: ' + sumMsrp.textContent) : null),
      'Final: ' + sumFinal.textContent,
      'MSRP √ó RV%: ' + sumTrue.textContent,
      'LVI: ' + (sumLvi ? sumLvi.textContent : '‚Äî')
    ].filter(Boolean);
    var text = parts.join(' | ');
    navigator.clipboard.writeText(text).then(function(){
      var old = copyBtn.innerHTML; copyBtn.innerHTML = '‚úÖ Copied!'; copyBtn.classList.add('success-flash');
      setTimeout(function(){ copyBtn.innerHTML = old; copyBtn.classList.remove('success-flash'); }, 1500);
    });
  });
  exportCsvBtn.addEventListener('click', exportVisibleCSV);
  printBtn.addEventListener('click', printSummary);
  validateBtn.addEventListener('click', function(){
    // simple inline validator dialog for embedded case
    try {
      validateJSON();
    } catch(e) {
      alert('Validator error: ' + e.message);
    }
  });

  leaseCapCost.addEventListener('input', function(){ leaseCompute(); runSniffer(); });
  leaseMF.addEventListener('input', function(){ leaseCompute(); compute(); runSniffer(); });
  leaseTax.addEventListener('input', function(){ leaseCompute(); runSniffer(); });
  leaseCapReduction.addEventListener('input', function(){ leaseCompute(); runSniffer(); });
  leaseFees.addEventListener('input', function(){ leaseCompute(); runSniffer(); });
  leaseTerm.addEventListener('input', function(){ leaseCompute(); runSniffer(); });

  rankPill.addEventListener('click', function(){
    rankMode = (rankMode === 'LVI_FIRST') ? 'PAYMENT_FIRST' : 'LVI_FIRST';
    rankPill.textContent = (rankMode === 'LVI_FIRST') ? 'LVI ‚ûú Payment' : 'Payment ‚ûú LVI';
    runSniffer();
  });

  // Prefill estimator defaults (editable)
  leaseCapCost.value = '165000';
  leaseMF.value = '0.00400';
  leaseTax.value = '9.75';
  leaseCapReduction.value = '7500';
  leaseFees.value = '1095';

  // Boot
  loadProgram('#embedded', 'Embedded PB 25-10R').then(function(){
    restoreFromParams();
    compute();
  });
})();
</script>
</body>
</html>
