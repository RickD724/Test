<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Residual Pro ‚Äî By Ricardo</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0e1a">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #050810;
    --bg-secondary: #0a0e1a;
    --card: rgba(255, 255, 255, 0.02);
    --card-hover: rgba(255, 255, 255, 0.05);
    --text: #e8edf5;
    --text-primary: #ffffff;
    --muted: #7c8ba1;
    --border: rgba(255, 255, 255, 0.06);
    --border-hover: rgba(59, 130, 246, 0.3);
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --accent-glow: rgba(59, 130, 246, 0.4);
    --success: #10b981;
    --success-glow: rgba(16, 185, 129, 0.3);
    --danger: #ef4444;
    --warning: #f59e0b;
    --purple: #8b5cf6;
    --purple-glow: rgba(139, 92, 246, 0.3);
    --radius: 20px;
    --radius-sm: 12px;
    --shadow: 0 20px 60px rgba(0,0,0,0.6);
    --shadow-lg: 0 30px 80px rgba(0,0,0,0.8);
    --glow: 0 0 40px var(--accent-glow);
    --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  [data-theme="light"]{
    --bg: #f5f7fa;
    --bg-secondary: #ffffff;
    --card: #ffffff;
    --card-hover: #f8fafc;
    --text: #1e293b;
    --text-primary: #0f172a;
    --muted: #64748b;
    --border: #e2e8f0;
    --border-hover: rgba(59, 130, 246, 0.4);
    --shadow: 0 10px 40px rgba(15,23,42,0.1);
    --shadow-lg: 0 20px 60px rgba(15,23,42,0.15);
    --glow: 0 0 40px rgba(59, 130, 246, 0.15);
    --accent-glow: rgba(59, 130, 246, 0.2);
    --success-glow: rgba(16, 185, 129, 0.2);
    --purple-glow: rgba(139, 92, 246, 0.2);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  @keyframes gradientShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }
  @keyframes slideInFromTop { from{transform:translateY(-30px);opacity:0} to{transform:translateY(0);opacity:1} }
  @keyframes fadeInUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
  @keyframes scaleIn { from{transform:scale(.9);opacity:0} to{transform:scale(1);opacity:1} }
  @keyframes shimmer { 0%{background-position:-1000px 0} 100%{background-position:1000px 0} }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }
  @keyframes fadePulse { 0%{opacity:0; transform:scale(.98);} 60%{opacity:1; transform:scale(1.02);} 100%{transform:scale(1);} }
  
  html, body{
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    overflow-x: hidden;
  }
  
  body {
    background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 50%, var(--bg) 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
  }
  
  .wrap { max-width: 980px; margin: 0 auto; padding: 20px 20px 100px; position: relative; }
  body::before {
    content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 20%, var(--accent-glow) 0%, transparent 50%), radial-gradient(circle at 70% 80%, var(--purple-glow) 0%, transparent 50%);
    opacity: 0.4; pointer-events: none; z-index: 0; animation: float 20s ease-in-out infinite;
  }
  body::after { content: ''; position: fixed; inset: 0; background: linear-gradient(90deg, transparent 0%, rgba(59, 130, 246, 0.03) 50%, transparent 100%); pointer-events: none; z-index: 0; }
  .wrap > * { position: relative; z-index: 1; }
  
  .top { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%);
    background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 24px; box-shadow: var(--shadow); animation: slideInFromTop 0.6s ease; }
  [data-theme="light"] .top { background: rgba(255,255,255,0.8); }
  
  .brand { display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .leftRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  
  .pill{
    display:inline-flex; align-items:center; gap:12px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
    background-size:200% 200%; animation: gradientShift 8s ease infinite;
    color:#fff; padding:12px 24px; border-radius:999px; font-weight:900; font-size:.95rem; letter-spacing:.5px;
    box-shadow:0 8px 30px var(--accent-glow); white-space:nowrap; transition:var(--transition); position:relative; overflow:hidden;
  }
  .pill::before{ content:''; position:absolute; inset:0; left:-100%; background:linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent); animation:shimmer 3s infinite; }
  .pill:hover{ transform:translateY(-3px) scale(1.05); box-shadow:0 12px 40px var(--accent-glow); }
  .pill.small { padding:6px 12px; font-size:.82rem; }
  .pillGroup .pill { margin-right: 6px; }
  
  .theme,.btn{
    border:1px solid var(--border); background:var(--card); backdrop-filter:blur(10px);
    color:var(--text); padding:10px 18px; border-radius:var(--radius-sm); cursor:pointer;
    font-weight:600; font-size:.9rem; transition:var(--transition); white-space:nowrap; font-family:'Inter',sans-serif; position:relative; overflow:hidden;
  }
  .theme::before,.btn::before{ content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:var(--accent-glow); transform:translate(-50%,-50%); transition:width .6s, height .6s; }
  .theme:hover::before,.btn:hover::before{ width:300px; height:300px; }
  .theme:hover,.btn:hover{ background:var(--card-hover); border-color:var(--border-hover); transform:translateY(-2px); box-shadow:0 8px 25px var(--accent-glow); }
  
  .select{ min-width:200px; transition:var(--transition); }
  .select:hover{ transform:scale(1.02); }
  
  .card{
    background:var(--card); backdrop-filter:blur(30px) saturate(180%); -webkit-backdrop-filter:blur(30px) saturate(180%);
    border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:28px; transition:var(--transition); animation:fadeInUp .6s ease; position:relative; overflow:hidden;
  }
  .card::before{ content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,var(--accent),transparent); opacity:0; transition:opacity .4s; }
  .card:hover{ border-color:var(--border-hover); box-shadow:var(--shadow-lg), var(--glow); transform:translateY(-5px); }
  .card:hover::before{ opacity:1; }
  
  .controls{ position:sticky; top:100px; z-index:20; animation-delay:.2s; }
  @media (max-width:900px){ .controls{ position:static; } }
  
  .grid{ display:grid; gap:18px; }
  .g4{ grid-template-columns:repeat(4,minmax(0,1fr)); }
  .g3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
  .g2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  @media (max-width:900px){ .g4,.g3,.g2{ grid-template-columns:1fr; } }
  
  label{ font-size:.75rem; color:var(--muted); display:block; margin:0 0 10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; transition:var(--transition); }
  .form-group:hover label{ color:var(--accent); }
  
  select,input[type="number"],input[type="text"]{
    width:100%; appearance:none; -webkit-appearance:none; background:var(--bg-secondary);
    color:var(--text); border:2px solid var(--border); border-radius:var(--radius-sm);
    padding:14px 18px; font-size:.95rem; font-weight:500; transition:var(--transition); font-family:'Inter',sans-serif;
  }
  select:focus,input:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 4px var(--accent-glow); background:var(--card); transform:translateY(-2px); }
  select:hover,input:hover{ border-color:var(--border-hover); }
  select{
    cursor:pointer;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:right 14px center; padding-right:45px;
  }
  input[type="checkbox"]{ width:24px; height:24px; cursor:pointer; accent-color:var(--accent); transition:var(--transition); }
  input[type="checkbox"]:hover{ transform:scale(1.1); }
  
  .muted{ color:var(--muted); }
  .hint{ font-size:.8rem; color:var(--muted); margin-top:8px; font-weight:500; font-style:italic; }
  .searchWrap{ max-width:280px; min-width:220px; }
  .rowline{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  
  .result{
    display:flex; align-items:baseline; gap:20px; margin:24px 0 20px; flex-wrap:wrap; padding:32px;
    background:linear-gradient(135deg, var(--accent-glow) 0%, var(--purple-glow) 100%);
    border-radius:var(--radius); border:2px solid var(--border-hover); position:relative; overflow:hidden; animation:scaleIn .6s ease;
  }
  .result::before{ content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%;
    background:linear-gradient(45deg, transparent, rgba(255,255,255,0.05), transparent); animation:shimmer 3s infinite; }
  .result .big{ font-size:4rem; font-weight:900; letter-spacing:-1px; background:linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; position:relative; z-index:1; text-shadow:0 0 40px var(--accent-glow); }
  .result .small{ font-size:1.1rem; font-weight:600; position:relative; z-index:1; }
  
  .tableWrap{ margin-top:20px; overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg-secondary); box-shadow:inset 0 2px 10px rgba(0,0,0,0.1); }
  table{ min-width:720px; width:100%; border-collapse:separate; border-spacing:0; }
  th,td{ padding:16px 20px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap; transition:var(--transition); }
  thead th{
    font-size:.75rem; color:var(--muted); font-weight:800; position:sticky; top:0;
    background:var(--card); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); z-index:1;
    text-transform:uppercase; letter-spacing:1px; border-bottom:2px solid var(--border-hover);
  }
  tbody tr{ transition:var(--transition); }
  tbody tr:hover{ background:var(--card-hover); transform:scale(1.01); }
  td.ok{ color: var(--success); font-weight:800; font-variant-numeric:tabular-nums; text-shadow:0 0 10px var(--success-glow); }
  td.err{ color:var(--danger); opacity:.5; }
  td:first-child,th:first-child{ position:sticky; left:0; background:var(--card); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); z-index:2; font-weight:800; }
  
  .summary{ margin-top:24px; padding:32px; border:2px solid var(--border-hover); border-radius:var(--radius); background:var(--card); backdrop-filter:blur(30px); box-shadow:var(--shadow-lg); animation:scaleIn .8s ease; animation-delay:.3s; animation-fill-mode:both; }
  .sum-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; margin-top:20px; }
  @media (max-width:700px){ .sum-grid{ grid-template-columns:1fr; } }
  
  .srow{
    display:flex; gap:16px; align-items:center; justify-content:space-between;
    background:linear-gradient(135deg, rgba(59,130,246,0.05), rgba(139,92,246,0.05));
    border:1px solid var(--border); border-radius:var(--radius-sm); padding:16px 20px; transition:var(--transition); position:relative; overflow:hidden;
  }
  .srow::before{ content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:linear-gradient(180deg, var(--accent), var(--purple)); transform:scaleY(0); transition:transform .4s; }
  .srow:hover::before{ transform:scaleY(1); }
  .srow:hover{ transform:translateX(8px); border-color:var(--border-hover); box-shadow:0 8px 25px var(--accent-glow);
    background:linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1)); }
  .slabel{ font-weight:700; color:var(--muted); font-size:.9rem; letter-spacing:.5px; }
  .sval{ font-variant-numeric:tabular-nums; font-weight:800; font-size:1.1rem; color:var(--text-primary); }
  
  .rv-label{ color:#bfa7ff; font-family:inherit; font-weight:700; letter-spacing:.02em; }
  .rv-value{ font-family:inherit; font-weight:800; color:var(--text-primary); }
  
  .badges{ display:flex; gap:12px; flex-wrap:wrap; margin-top:20px; }
  .badge{
    background:linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.1));
    border:1px solid var(--border-hover); padding:10px 20px; border-radius:999px; font-size:.85rem; font-weight:700; transition:var(--transition); animation:fadeInUp .8s ease; letter-spacing:.3px;
  }
  .badge:hover{ transform:translateY(-3px) scale(1.05); box-shadow:0 8px 20px var(--accent-glow);
    background:linear-gradient(135deg, rgba(59,130,246,0.3), rgba(139,92,246,0.2)); }
  
  .footer{ margin:40px 0 20px; animation:fadeInUp 1s ease; }
  .foot-card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:28px 32px; text-align:center; }
  .foot-title{
    font-weight:900; letter-spacing:.5px; margin-bottom:12px; font-size:1.2rem;
    background:linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  }
  .foot-text{ color:var(--muted); font-size:.95rem; line-height:1.8; }
  
  @media (max-width:768px){
    .result .big{ font-size:2.5rem; }
    .card{ padding:20px; }
    .summary{ padding:20px; }
  }
  @media print{
    body{ background:#fff; }
    .top,.controls,.tableWrap,#leaseCard,.footer,#validatorCard{ display:none !important; }
    .summary{ border:0; box-shadow:none; }
  }

  /* savings hint green/red + pulse */
  .hint.pulse { animation: fadePulse .45s ease; }
  .hint.good { color: var(--success); font-weight: 700; }
  .hint.bad { color: var(--danger); font-weight: 700; }

  /* iPhone very-narrow layout tweak for pre/with-tax stacking */
  @media (max-width: 375px){
    #leaseMonthlyWrap{ display:flex; flex-direction:column; gap:10px; }
  }
</style>

</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="leftRow">
          <div class="pill">‚ö° Residual Pro ‚Äî By Ricardo</div>
          <select id="programSel" class="select">
            <option value="porsche_residuals_all.json" selected>Program: PB 25-10R (Default)</option>
            <option value="porsche_residuals_25-09R.json">Program: PB 25-09R (Oct)</option>
            <option value="__current__">Program: Current (from ?data or default)</option>
          </select>
        </div>
        <div class="leftRow">
          <button id="jumpSummaryBtn" class="btn" type="button" title="Scroll to Summary">üìä Summary</button>
          <button id="validateBtn" class="btn" type="button" title="Validate loaded JSON">‚úì Validate</button>
          <button id="exportCsvBtn" class="btn" type="button" title="Export table as CSV">üì• Export</button>
          <button id="printBtn" class="btn" type="button" title="Print summary">üñ®Ô∏è Print</button>
          <button id="themeBtn" class="theme" type="button">üåô Dark</button>
        </div>
      </div>
    </div>

    <div class="card controls" id="controls">
      <div class="grid g4">
        <div>
          <label>üöó Model Family</label>
          <select id="familySel"></select>
        </div>
        <div>
          <label>üìÖ Model Year</label>
          <select id="yearSel"></select>
        </div>
        <div>
          <label>üéØ Trim</label>
          <select id="trimSel"></select>
          <div class="hint" id="trimCount"></div>
          <div class="hint" id="trimWarn" style="display:none;color:var(--danger);">‚ö†Ô∏è No trims found</div>
        </div>
        <div class="searchWrap">
          <label>üîç Search Trim</label>
          <input id="trimSearch" type="text" placeholder="Type to filter..." />
        </div>
      </div>

      <div class="grid g3" style="margin-top: 16px">
        <div>
          <label>‚è±Ô∏è Term (months)</label>
          <select id="termSel"></select>
        </div>
        <div>
          <label>üìä Miles per Year</label>
          <select id="annualMilesSel"></select>
        </div>
        <div class="rowline" style="margin-top: 32px">
          <label class="rowline" style="gap: 10px;">
            <input id="pacpoToggle" type="checkbox" />
            <span>+2% PACPO</span>
          </label>
          <label class="rowline" style="gap: 10px;">
            <input id="hideNA" type="checkbox" />
            <span>Hide N/A</span>
          </label>
          <div class="pill small" id="codeBadge">Code: ‚Äî</div>
        </div>
      </div>

      <div class="grid g3" style="margin-top: 16px">
        <div>
          <label>üõ£Ô∏è Miles at Inception</label>
          <input id="odoInput" type="number" min="0" step="1" placeholder="e.g., 3,450" />
          <div class="hint">Adjustment shown even at +0%</div>
        </div>
        <div>
          <label>üí∞ MSRP ($)</label>
          <input id="msrpInput" type="number" min="0" step="100" placeholder="e.g., 142,000" />
        </div>
        <div>
          <label>üîó Shareable Link</label>
          <input id="shareLink" type="text" readonly style="font-size:0.85rem;" />
          <div class="hint">Auto-updates ‚Äî copy to share calc</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 20px; animation-delay: 0.4s;">
      <div class="result">
        <div class="big" id="finalOut">‚Äî</div>
        <div class="small muted" id="detailOut">Select options to calculate</div>
        <div class="small" id="trueOut" style="font-weight:800;"></div>
        <div class="small muted" id="lviBadge" style="font-weight:700;"></div>
      </div>

      <div class="tableWrap">
        <table id="residualTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody><tr id="tvalRow"></tr></tbody>
        </table>
      </div>

      <div class="summary" id="summaryBox">
        <div class="rowline" style="justify-content:space-between;">
          <strong style="font-size:1.3rem;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üìã Summary</strong>
          <button id="copyBtn" class="theme btn" type="button">üìÑ Copy</button>
        </div>

        <div class="srow" style="margin-top:16px; border:3px solid var(--accent); box-shadow: var(--glow); background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));">
          <span class="slabel" style="color:var(--accent);font-size:1rem;">Final Residual</span>
          <span class="sval" id="sumFinal" style="font-size:1.8rem;color:var(--accent);font-weight:900;">‚Äî</span>
        </div>

        <div class="sum-grid">
          <div class="srow" style="display:none;">
            <span class="slabel">Program</span><span class="sval" id="sumProgram">‚Äî</span>
          </div>
          <div class="srow"><span class="slabel">Model Year</span><span class="sval" id="sumYear">‚Äî</span></div>
          <div class="srow"><span class="slabel">Family</span><span class="sval" id="sumFamily">‚Äî</span></div>
          <div class="srow"><span class="slabel">Trim</span><span class="sval" id="sumTrim">‚Äî</span></div>
          <div class="srow"><span class="slabel">Term</span><span class="sval" id="sumTerm">‚Äî</span></div>
          <div class="srow"><span class="slabel">Miles/Year</span><span class="sval" id="sumMilesYear">‚Äî</span></div>
          <div class="srow"><span class="slabel">Odometer</span><span class="sval" id="sumOdo">‚Äî</span></div>
          <div class="srow" style="display:none;">
            <span class="slabel">MSRP</span><span class="sval" id="sumMsrp">‚Äî</span>
          </div>
          <div class="srow"><span class="slabel">MSRP √ó RV%</span><span class="sval" id="sumTrue">‚Äî</span></div>
          <div class="srow">
            <span class="slabel">Value Index</span>
            <span class="sval" id="sumLvi" title="Higher is better">‚Äî</span>
          </div>
        </div>
        <div class="hint" id="lviHelp" style="margin-top:12px;text-align:center;">üí° Higher Value Index = Better Deal</div>

        <div class="badges" id="badgeRow" aria-label="Adjustments"></div>
      </div>
    </div>

    <div class="card" id="leaseCard" style="margin-top: 20px; animation-delay: 0.6s;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:16px;">
        <strong style="font-size:1.2rem;background:linear-gradient(135deg,var(--success),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üí≥ Lease Estimator</strong>
        <span class="muted" style="font-size:0.95rem;font-style:italic;">Uses current RV% & term</span>
      </div>

      <div class="grid g3">
        <div>
          <label>üíµ Cap Cost ($)</label>
          <input id="leaseCapCost" type="number" min="0" step="100" placeholder="e.g., 165000" />
          <div class="hint">Selling price before down</div>
        </div>
        <div>
          <label>üìà Money Factor</label>
          <input id="leaseMF" type="number" min="0" step="0.00001" placeholder="e.g., 0.00210" />
          <div class="hint">Decimal format (0.00210)</div>
          <div class="hint" id="mfAprHint"></div>
        </div>
        <div>
          <label>üßæ Tax Rate (%)</label>
          <input id="leaseTax" type="number" min="0" step="0.01" placeholder="e.g., 9.375" />
        </div>
      </div>

      <div class="grid g3" style="margin-top:14px">
        <div>
          <label>üí∏ Cap Reduction ($)</label>
          <input id="leaseCapReduction" type="number" min="0" step="100" placeholder="0" />
          <div class="hint">Cash down (optional)</div>
        </div>
        <div>
          <label>üìù Rolled Fees ($)</label>
          <input id="leaseFees" type="number" min="0" step="25" placeholder="0" />
          <div class="hint">Acq/Doc fees (optional)</div>
        </div>
        <div>
          <label>‚è∞ Term (mo)</label>
          <input id="leaseTerm" type="number" min="12" step="1" placeholder="auto" />
          <div class="hint">Auto-fills from selection</div>
        </div>
      </div>

      <div id="leaseMonthlyWrap" class="grid g2" style="margin-top:16px">
        <div class="srow" style="border:2px solid var(--success);"><span class="slabel" style="color:var(--success);">Monthly (Pre-Tax)</span><span class="sval" id="leasePreTax" style="color:var(--success);font-size:1.3rem;">‚Äî</span></div>
        <div class="srow" style="border:2px solid var(--purple);"><span class="slabel" style="color:var(--purple);">Monthly (With Tax)</span><span class="sval" id="leaseWithTax" style="color:var(--purple);font-size:1.3rem;">‚Äî</span></div>
      </div>
    </div>

    <!-- Lease Sniffer -->
    <div class="card" id="snifferCard" style="margin-top: 20px; animation-delay: 0.7s;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:8px;">
        <strong style="font-size:1.05rem;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üïµÔ∏è Lease Sniffer ‚Äî Top 6</strong>
        <div class="rowline" style="gap:8px; align-items:center;">
          <span id="rankNote" class="muted" style="font-size:0.9rem;">Ranks by Value Index (LVI) first, then With-Tax payment</span>
          <div class="pillGroup">
            <button id="pillLVI" class="pill small" type="button" data-mode="lvi">LVI ‚Üí $/mo</button>
            <button id="pillPAY" class="pill small" type="button" data-mode="pay" style="opacity:.7;">$/mo ‚Üí LVI</button>
          </div>
        </div>
      </div>
      <div id="sniffSummary" class="hint">Showing best 6 terms (final RV%, same structure)</div>
      <div id="snifferList" style="margin-top:10px;"></div>
    </div>

    <div class="card" id="validatorCard" style="margin-top:16px; display:none; animation-delay:0.8s;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:12px;">
        <strong style="font-size:1.1rem;">üîç JSON Validator</strong>
        <button id="closeValBtn" class="btn" type="button">‚úï Close</button>
      </div>
      <div id="validatorOutput" class="muted" style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:0.9rem; line-height:1.8;"></div>
    </div>

    <div class="footer">
      <div class="foot-card">
        <div class="foot-title">‚ú® Crafted by Ricardo</div>
        <div class="foot-text">
          ¬© Ricardo. This internal tool is confidential and intended for authorized use only.
          <br>Do not share, copy, or redistribute without written permission.
          <br><strong>Built with precision. Used with trust.</strong>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // --- PWA icons/manifest quick-gen (kept minimal, as in your original style) ---
  (function generateIconsAndManifest(){
    try{
      var canvas = document.createElement('canvas');
      canvas.width = canvas.height = 512;
      var ctx = canvas.getContext('2d');
      var grad = ctx.createLinearGradient(0,0,512,512);
      grad.addColorStop(0,'#3b82f6'); grad.addColorStop(1,'#8b5cf6');
      ctx.fillStyle = grad; ctx.fillRect(0,0,512,512);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 280px Inter, Arial, sans-serif';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText('R', 256, 270);
      canvas.toBlob(function(blob){
        if(!blob) return;
        var iconURL = URL.createObjectURL(blob);
        var linkApple = document.createElement('link'); linkApple.rel = 'apple-touch-icon'; linkApple.href = iconURL;
        document.head.appendChild(linkApple);
        var manifest = {
          name: "Residual Pro ‚Äî By Ricardo",
          short_name: "Residual Pro",
          start_url: ".",
          display: "standalone",
          background_color: "#050810",
          theme_color: "#3b82f6",
          icons: [{ src: iconURL, sizes: "512x512", type: "image/png", purpose: "any maskable" }]
        };
        var blobMan = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
        var manURL = URL.createObjectURL(blobMan);
        var linkMan = document.createElement('link'); linkMan.rel = 'manifest'; linkMan.href = manURL;
        document.head.appendChild(linkMan);
      }, 'image/png');
    }catch(e){}
  })();

  // --- Theme default to LIGHT; allow manual toggle ---
  var themeBtn = document.getElementById('themeBtn');
  document.documentElement.setAttribute('data-theme', 'light');
  themeBtn.innerHTML = 'üåô Dark';
  themeBtn.addEventListener('click', function(){
    var cur = document.documentElement.getAttribute('data-theme');
    var next = cur === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    themeBtn.innerHTML = next === 'light' ? 'üåô Dark' : '‚òÄÔ∏è Light';
    themeBtn.classList.add('success-flash');
    setTimeout(function(){ themeBtn.classList.remove('success-flash'); }, 600);
  });

  // --- DOM refs ---
  var programSel = document.getElementById('programSel');
  var validateBtn = document.getElementById('validateBtn');
  var exportCsvBtn = document.getElementById('exportCsvBtn');
  var printBtn = document.getElementById('printBtn');
  var jumpSummaryBtn = document.getElementById('jumpSummaryBtn');
  var familySel = document.getElementById('familySel');
  var yearSel = document.getElementById('yearSel');
  var trimSel = document.getElementById('trimSel');
  var trimSearch = document.getElementById('trimSearch');
  var trimCount = document.getElementById('trimCount');
  var trimWarn = document.getElementById('trimWarn');
  var termSel = document.getElementById('termSel');
  var pacpoToggle = document.getElementById('pacpoToggle');
  var hideNA = document.getElementById('hideNA');
  var codeBadge = document.getElementById('codeBadge');
  var finalOut = document.getElementById('finalOut');
  var detailOut = document.getElementById('detailOut');
  var trueOut = document.getElementById('trueOut');
  var theadRow = document.getElementById('theadRow');
  var tvalRow = document.getElementById('tvalRow');
  var annualMilesSel = document.getElementById('annualMilesSel');
  var odoInput = document.getElementById('odoInput');
  var msrpInput = document.getElementById('msrpInput');
  var shareLink = document.getElementById('shareLink');
  var sumProgram = document.getElementById('sumProgram');
  var sumYear = document.getElementById('sumYear');
  var sumFamily = document.getElementById('sumFamily');
  var sumTrim = document.getElementById('sumTrim');
  var sumTerm = document.getElementById('sumTerm');
  var sumMilesYear = document.getElementById('sumMilesYear');
  var sumOdo = document.getElementById('sumOdo');
  var sumMsrp = document.getElementById('sumMsrp');
  var sumTrue = document.getElementById('sumTrue');
  var sumFinal = document.getElementById('sumFinal');
  var badgeRow = document.getElementById('badgeRow');
  var copyBtn = document.getElementById('copyBtn');
  var leaseCapCost = document.getElementById('leaseCapCost');
  var leaseMF = document.getElementById('leaseMF');
  var leaseTax = document.getElementById('leaseTax');
  var leaseCapReduction = document.getElementById('leaseCapReduction');
  var leaseFees = document.getElementById('leaseFees');
  var leaseTerm = document.getElementById('leaseTerm');
  var leaseRvPct = document.getElementById('leaseRvPct');
  var leaseRvAmt = document.getElementById('leaseRvAmt');
  var leaseAdjCap = document.getElementById('leaseAdjCap');
  var leasePreTax = document.getElementById('leasePreTax');
  var leaseWithTax = document.getElementById('leaseWithTax');
  var mfAprHint = document.getElementById('mfAprHint');
  var lviBadge = document.getElementById('lviBadge');
  var sumLvi = document.getElementById('sumLvi');
  var validatorCard = document.getElementById('validatorCard');
  var closeValBtn = document.getElementById('closeValBtn');
  var validatorOutput = document.getElementById('validatorOutput');

  // Sniffer controls
  var rankNote = document.getElementById('rankNote');
  var pillLVI = document.getElementById('pillLVI');
  var pillPAY = document.getElementById('pillPAY');
  var sniffRank = (localStorage.getItem('sniffRank') || 'lvi'); // 'lvi' or 'pay'

  var data, MONTHS = [], PACPO = 2;
  var fullTrimList = [];
  var currentProgramLabel = 'Current';
  var leaseTermDirty = false; // allow manual override after auto-fill

  function readParams(){
    var p = new URLSearchParams(location.search);
    return {
      program: p.get('data') || null, family: p.get('family') || null, year: p.get('year') || null,
      trim: p.get('trim') || null, term: p.get('term') || null, miles: p.get('miles') || null,
      odo: p.get('odo') || null, pacpo: p.get('pacpo') || null, hidena: p.get('hidena') || null,
      msrp: p.get('msrp') || null
    };
  }
  function updateShareURL(){
    var p = new URLSearchParams();
    var program = (programSel.value === '__current__') ? (initialProgram || 'porsche_residuals_all.json') : programSel.value;
    p.set('data', program);
    if(familySel.value) p.set('family', familySel.value);
    if(yearSel.value) p.set('year', yearSel.value);
    if(trimSel.value) p.set('trim', trimSel.value);
    if(termSel.value) p.set('term', termSel.value);
    if(annualMilesSel.value) p.set('miles', annualMilesSel.value);
    if(odoInput.value) p.set('odo', odoInput.value);
    if(pacpoToggle.checked) p.set('pacpo', '1');
    if(hideNA.checked) p.set('hidena', '1');
    if(msrpInput.value) p.set('msrp', msrpInput.value);
    var url = location.pathname + '?' + p.toString();
    shareLink.value = location.origin + url;
    history.replaceState(null, '', url);
  }

  function normalizeYearKey(k){
    var s = String(k).trim();
    var mPlain = s.match(/^(20\\d{2})$/); if (mPlain) return { display: 'MY' + mPlain[1].slice(-2), key: k };
    var mMY = s.toUpperCase().replace(/\\s+/g,'').match(/^MY(\\d{2})$/); if (mMY) return { display: 'MY' + mMY[1], key: k };
    return { display: s, key: k };
  }
  function getCaseInsensitive(obj, name){
    if(!obj || typeof obj !== "object") return undefined;
    var target = String(name).replace(/\\s+/g,'').toLowerCase();
    var keys = Object.keys(obj);
    for(var i=0;i<keys.length;i++){ if(keys[i].replace(/\\s+/g,'').toLowerCase() === target) return obj[keys[i]]; }
    return undefined;
  }
  function getVirtualFamilies(){
    var out = new Set();
    var models = data.models || {};
    Object.keys(models).forEach(function(f){
      if(f === '718'){
        var cay = getCaseInsensitive(models['718'],'Cayman');
        var box = getCaseInsensitive(models['718'],'Boxster');
        if (cay) out.add('718 Cayman'); if (box) out.add('718 Boxster');
      } else { out.add(f); }
    });
    if(models['Cayman']) out.add('718 Cayman');
    if(models['Boxster']) out.add('718 Boxster');
    var order = ['911','718 Cayman','718 Boxster','Taycan','Macan','Cayenne','Panamera'];
    return Array.from(out).sort(function(a,b){ return order.indexOf(a) - order.indexOf(b); });
  }
  function branchForFamily(famDisp){
    var models = data.models || {};
    if (famDisp === '718 Cayman') return getCaseInsensitive(models['718']||{}, 'Cayman') || models['Cayman'] || {};
    if (famDisp === '718 Boxster') return getCaseInsensitive(models['718']||{}, 'Boxster') || models['Boxster'] || {};
    return models[famDisp] || {};
  }
  function yearsForFamily(famDisp){
    var out = new Set(); var branch = branchForFamily(famDisp);
    Object.keys(branch).forEach(function(k){ out.add(normalizeYearKey(k).display); });
    return Array.from(out).sort(function(a,b){
      var ay = parseInt(a.replace(/\\D/g,''),10), by = parseInt(b.replace(/\\D/g,''),10);
      if (isNaN(ay) || isNaN(by)) return b.localeCompare(a);
      return by - ay;
    });
  }
  function populate(select, arr){
    select.innerHTML = '';
    arr.forEach(function(v){ var opt = document.createElement('option'); opt.value = v; opt.textContent = v; select.appendChild(opt); });
  }
  function initSelectors(){
    populate(familySel, getVirtualFamilies());
    populate(yearSel, yearsForFamily(familySel.value));
    termSel.innerHTML = '';
    MONTHS.forEach(function(m){ var opt = document.createElement('option'); opt.value = m; opt.textContent = m + ' months'; termSel.appendChild(opt); });
    populateAnnualMiles();
    collectTrimsForYear();
    populateTrims('');
  }
  function populateAnnualMiles(){
    annualMilesSel.innerHTML = '';
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {
      "2500":6,"5000":5,"7500":4,"10000":3,"12000":2,"15000":0
    };
    Object.keys(milesMap).map(function(k){ return parseInt(k,10); }).sort(function(a,b){ return a-b; })
      .forEach(function(n){ var opt = document.createElement('option'); opt.value = String(n); opt.textContent = n.toLocaleString() + ' mi/yr'; annualMilesSel.appendChild(opt); });
    annualMilesSel.value = "15000";
  }
  function collectTrimsForYear(){
    fullTrimList = [];
    var branch = branchForFamily(familySel.value);
    var dispYear = yearSel.value;
    var yearKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var rows = (yearKey && branch[yearKey]) || {};
    Object.entries(rows).forEach(function(entry){ fullTrimList.push({code: entry[0], model: entry[1].model || entry[0]}); });
  }
  function populateTrims(filterTerm){
    trimSel.innerHTML = '';
    var term = (filterTerm||'').trim().toLowerCase();
    var filtered = fullTrimList.filter(function(t){ return (t.model + " " + t.code).toLowerCase().indexOf(term) !== -1; });
    filtered.forEach(function(item){ var opt = document.createElement('option'); opt.value = item.code; opt.textContent = item.model; opt.dataset.code = item.code; trimSel.appendChild(opt); });
    trimCount.textContent = filtered.length ? (filtered.length + ' trim(s) available') : 'No matches';
    trimWarn.style.display = filtered.length ? 'none' : 'block';
  }
  function parseRange(str){
    if(!str) return null;
    var s = str.replace(/,/g,'').replace(/\\s/g,'');
    var parts = s.split(/‚Äì|-/); if(parts.length !== 2) return null;
    var a = parseInt(parts[0],10), b = parseInt(parts[1],10);
    if(isNaN(a) || isNaN(b)) return null;
    return [a,b];
  }
  function findInceptionAdj(myKey, odo){
    var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[myKey]) || null;
    if(!bands || odo == null) return 0;
    for(var i=0;i<bands.length;i++){
      var rng = parseRange(bands[i].miles_range); if(!rng) continue;
      if(odo >= rng[0] && odo <= rng[1]) return bands[i].adj || 0;
    }
    return 0;
  }
  function visibleMonthsFor(entry){
    if(!hideNA.checked) return MONTHS.slice();
    var result = [];
    for(var i=0;i<MONTHS.length;i++){ if(entry && entry.residuals && entry.residuals[MONTHS[i]] != null) result.push(MONTHS[i]); }
    return result;
  }
  function buildHeader(visibleMonths){
    theadRow.innerHTML = '';
    var th1 = document.createElement('th'); th1.textContent = 'Trim / Term'; theadRow.appendChild(th1);
    visibleMonths.forEach(function(m){ var th = document.createElement('th'); th.textContent = m + ' mo'; theadRow.appendChild(th); });
  }
  function computeLVI(rvPercent, mf){ if(!isFinite(rvPercent) || !isFinite(mf) || mf <= 0) return null; return rvPercent / mf; }

  function compute(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var code = trimSel.value;
    var term = termSel.value;
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;

    if(!yrKey || !code){
      finalOut.textContent = '‚Äî'; detailOut.textContent = 'Select family/year/trim'; trueOut.textContent = '';
      if(lviBadge) lviBadge.textContent = ''; if(sumLvi) sumLvi.textContent = '‚Äî';
      updateShareURL(); sniffRun(); return;
    }

    var entry = branch[yrKey][code];
    var base = term ? ((entry && entry.residuals && entry.residuals[term]) || null) : null;
    var PACPOpct = data.pacpo_bonus_percent || 2;
    var pacpoAdj = pacpoToggle.checked ? PACPOpct : 0;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var annualAdj = 0;
    if(base !== null && parseInt(term || "0", 10) >= 24){ annualAdj = milesMap[String(milesPerYear)] || 0; }

    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\\s+/g,'')];
    var inceptionAdj = 0;
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    var monthsShown = visibleMonthsFor(entry);
    buildHeader(monthsShown);

    var final = (base === null || term == null) ? null : (base + pacpoAdj + annualAdj + inceptionAdj);
    finalOut.textContent = final === null ? '‚Äî' : final + '%';
    finalOut.classList.add('success-flash'); setTimeout(function(){ finalOut.classList.remove('success-flash'); }, 600);
    detailOut.textContent = final === null ? 'Select a term' : 'Final with all adjustments';
    codeBadge.textContent = 'Code: ' + (code || '‚Äî');

    tvalRow.innerHTML = '';
    var lead = document.createElement('td'); lead.textContent = (entry && entry.model) || '‚Äî'; tvalRow.appendChild(lead);
    monthsShown.forEach(function(m){
      var td = document.createElement('td');
      var v = entry && entry.residuals && entry.residuals[m];
      var shown = '‚Äî';
      if(v !== null && v !== undefined){
        var mN = parseInt(m, 10);
        var aAdj = (mN >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
        var total = v + pacpoAdj + aAdj + inceptionAdj;
        shown = total + '%'; td.classList.add('ok');
      } else { td.classList.add('err'); }
      td.textContent = shown; tvalRow.appendChild(td);
    });

    sumYear.textContent = dispYear || '‚Äî';
    sumFamily.textContent = fam || '‚Äî';
    sumTrim.textContent = (entry && entry.model) || '‚Äî';
    sumTerm.textContent = term ? (term + ' mo') : '‚Äî';
    sumMilesYear.textContent = Number.isFinite(milesPerYear) ? milesPerYear.toLocaleString() + ' mi/yr' : '‚Äî';
    sumOdo.textContent = (odo != null && !isNaN(odo)) ? odo.toLocaleString() + ' mi' : '‚Äî';

    var msrp = msrpInput.value ? Number(msrpInput.value) : null;
    if (sumMsrp) sumMsrp.textContent = (msrp != null && !isNaN(msrp)) ? ('$' + msrp.toLocaleString()) : '‚Äî';
    var trueResidual = (final != null && msrp != null && !isNaN(msrp)) ? Math.round(msrp * (final/100)) : null;
    sumTrue.textContent = (trueResidual != null) ? ('$' + trueResidual.toLocaleString()) : '‚Äî';

    trueOut.innerHTML = (trueResidual != null) ? ('<span class="rv-label">MSRP √ó RV% = </span><span class="rv-value">$' + trueResidual.toLocaleString() + '</span>') : '';

    badgeRow.innerHTML = '';
    if(base !== null && term){ addBadge('Base ' + base + '%'); }
    if(pacpoToggle.checked){ addBadge('+' + PACPOpct + '% PACPO'); }
    if(term && parseInt(term, 10) >= 24){ addBadge(((annualAdj>=0?'+':'') + annualAdj + '%') + ' Annual'); }
    if(odo != null && !isNaN(odo)){ addBadge(((inceptionAdj>=0?'+':'') + inceptionAdj + '%') + ' Inception'); }

    sumFinal.textContent = final === null ? '‚Äî' : final + '%';

    var mfVal = leaseMF && leaseMF.value ? Number(leaseMF.value) : NaN;
    var lviCurrent = computeLVI(final, mfVal);
    if(lviCurrent != null){
      var lviText = (lviCurrent/1000).toFixed(1) + 'k';
      if(lviBadge) lviBadge.textContent = 'LVI: ' + lviText;
      if(sumLvi) sumLvi.textContent = lviText;
    } else {
      if(lviBadge) lviBadge.textContent = '';
      if(sumLvi) sumLvi.textContent = '‚Äî';
    }

    updateShareURL();
    if(leaseTerm && (!leaseTerm.value || leaseTerm.value === '')) {
      if(termSel && termSel.value && !leaseTermDirty){ leaseTerm.value = termSel.value; }
    }
    leaseCompute();
    sniffRun(); // auto-run sniffer after every compute
    setTimeout(updateSnifferHints, 0);
  }

  function addBadge(txt){
    var b = document.createElement('div'); b.className = 'badge'; b.textContent = txt; badgeRow.appendChild(b);
  }
  function exportVisibleCSV(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    if(!yrKey || !trimSel.value){ alert('Select family/year/trim first.'); return; }
    var entry = branch[yrKey][trimSel.value];
    var monthsShown = visibleMonthsFor(entry);

    var rows = [];
    rows.push(['Trim/Term'].concat(monthsShown.map(function(m){return m + ' mo';})));
    var line = [(entry && entry.model) || '‚Äî'];
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    var pacpoAdj = pacpoToggle.checked ? (data.pacpo_bonus_percent || 2) : 0;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\\s+/g,'')];
    var inceptionAdj = 0;
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    monthsShown.forEach(function(m){
      var v = entry && entry.residuals && entry.residuals[m];
      if(v==null){ line.push(''); return; }
      var aAdj = (parseInt(m,10) >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
      var total = v + pacpoAdj + aAdj + inceptionAdj;
      line.push(total + '%');
    });
    rows.push(line);

    rows.push([]);
    rows.push(['Program', currentProgramLabel]);
    rows.push(['Year', dispYear], ['Family', fam], ['Trim', (entry && entry.model)||'‚Äî'], ['Term', termSel.value ? termSel.value+' mo':'‚Äî']);
    rows.push(['Miles/Year', sumMilesYear.textContent], ['Odometer', sumOdo.textContent], ['Final', sumFinal.textContent]);
    if(msrpInput.value){ rows.push(['MSRP', '$'+Number(msrpInput.value).toLocaleString()], ['MSRP √ó RV%', sumTrue.textContent]); }

    var csv = rows.map(function(r){
      return r.map(function(c){
        var s = (c==null ? '' : String(c));
        if(s.indexOf('"')!=-1 || s.indexOf(',')!=-1) s='"'+s.replace(/"/g,'""')+'"';
        return s;
      }).join(',');
    }).join('\\r\\n');

    var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href = url;
    var safeTrim = ((entry && entry.model)||'trim').replace(/[^\\w\\-]+/g,'_');
    a.download = 'residual_' + safeTrim + '_' + (dispYear||'MY').replace(/\\s+/g,'') + '.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function printSummary(){ window.print(); }
  function validateJSON(){
    if(!data){ alert('Load a program first.'); return; }
    var issues = [];
    var models = data.models || {};
    var totalTrims = 0, missingCells = 0;
    function checkEntry(modelFamily, yearKey, code, entry){
      totalTrims++;
      var resids = entry.residuals || {};
      MONTHS.forEach(function(m){
        if(!(m in resids) || resids[m] == null){
          missingCells++;
          issues.push('Missing ‚Üí ['+modelFamily+'] ['+yearKey+'] ['+(entry.model||code)+'] term '+m+' mo');
        }
      });
    }
    Object.keys(models).forEach(function(fam){
      var famBranch = models[fam];
      if(!famBranch || typeof famBranch!=='object') return;
      Object.keys(famBranch).forEach(function(yearKey){
        var group = famBranch[yearKey];
        if(!group || typeof group!=='object'){ issues.push('Bad year group at '+fam+' / '+yearKey); return; }
        Object.keys(group).forEach(function(code){
          var entry = group[code];
          if(!entry || typeof entry!=='object'){ issues.push('Bad entry at '+fam+' / '+yearKey+' / '+code); return; }
          if(!('model' in entry)) issues.push('No "model" at '+fam+' / '+yearKey+' / '+code);
          if(!('residuals' in entry)) issues.push('No "residuals" at '+fam+' / '+yearKey+' / '+code);
          else checkEntry(fam, yearKey, code, entry);
        });
      });
    });
    if(!data.annual_mileage_adjustments_percent || !data.annual_mileage_adjustments_percent.miles_per_year){
      issues.push('annual_mileage_adjustments_percent.miles_per_year missing');
    }
    if(!data.mileage_at_inception_adjustments_percent){
      issues.push('mileage_at_inception_adjustments_percent missing');
    }
    var out = [];
    out.push('Program: ' + (currentProgramLabel || 'Unknown'));
    out.push('MONTHS: ' + JSON.stringify(MONTHS));
    out.push('PACPO: ' + (data.pacpo_bonus_percent || 2) + '%');
    out.push('Trims: ' + totalTrims);
    out.push('Missing cells: ' + missingCells);
    out.push('‚Äî');
    if(issues.length===0) out.push('‚úÖ No issues found!');
    else out.push('‚ö†Ô∏è Issues ('+issues.length+'):'); issues.forEach(function(line){ out.push(' ‚Ä¢ ' + line); });
    validatorOutput.textContent = out.join('\\n');
    validatorCard.style.display = 'block';
  }

  function leaseCompute(){
    var rvPctText = sumFinal.textContent;
    var rvPct = (rvPctText && rvPctText.endsWith('%')) ? parseFloat(rvPctText) : NaN;
    var msrp = msrpInput.value ? Number(msrpInput.value) : NaN;
    var term = leaseTerm.value ? parseInt(leaseTerm.value, 10)
                               : (termSel && termSel.value ? parseInt(termSel.value,10) : NaN);
    var cap = leaseCapCost.value ? Number(leaseCapCost.value) : NaN;
    var mf = leaseMF.value ? Number(leaseMF.value) : NaN;
    var tax = leaseTax.value ? Number(leaseTax.value)/100 : 0;
    var capRed = leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    var fees = leaseFees.value ? Number(leaseFees.value) : 0;

    if (!leaseTermDirty && termSel && termSel.value) { leaseTerm.value = termSel.value; }

    if(isFinite(mf)) mfAprHint.textContent = '‚âà ' + (mf*2400).toFixed(2) + '% APR'; else mfAprHint.textContent = '';

    leaseRvPct && (leaseRvPct.textContent = isFinite(rvPct) ? (rvPct.toFixed(2) + '%') : '‚Äî');

    if(!isFinite(msrp) || !isFinite(rvPct) || !isFinite(term) || term <= 0){
      leaseRvAmt && (leaseRvAmt.textContent = '‚Äî');
      leaseAdjCap && (leaseAdjCap.textContent = '‚Äî');
      leasePreTax && (leasePreTax.textContent = '‚Äî');
      leaseWithTax && (leaseWithTax.textContent = '‚Äî');
      return;
    }

    var rvAmt = Math.round(msrp * (rvPct/100));
    leaseRvAmt && (leaseRvAmt.textContent = '$' + rvAmt.toLocaleString());

    var adjCap = (isFinite(cap) ? cap : 0) - (isFinite(capRed) ? capRed : 0) + (isFinite(fees) ? fees : 0);
    leaseAdjCap && (leaseAdjCap.textContent = isFinite(adjCap) ? ('$' + adjCap.toLocaleString()) : '‚Äî');

    if(!isFinite(adjCap) || adjCap <= 0 || !isFinite(mf) || mf <= 0){
      leasePreTax && (leasePreTax.textContent = '‚Äî');
      leaseWithTax && (leaseWithTax.textContent = '‚Äî');
      return;
    }

    var dep = (adjCap - rvAmt) / term;
    var fin = (adjCap + rvAmt) * mf;
    var preTax = dep + fin;
    var withTax = preTax * (1 + (isFinite(tax) ? tax : 0));

    leasePreTax && (leasePreTax.textContent = '$' + Math.round(preTax).toLocaleString());
    leaseWithTax && (leaseWithTax.textContent = '$' + Math.round(withTax).toLocaleString());
  }

  // === Helper: update sniffer savings hint (colors + pulse) against current With-Tax ===
  function updateSnifferHints(){
    try{
      var curTxt = (leaseWithTax && leaseWithTax.textContent) ? leaseWithTax.textContent : '';
      var curPay = Number((curTxt||'').replace(/[^0-9.]/g,''));
      document.querySelectorAll('#snifferList .sniffItem').forEach(function(card){
        var wt = Number(card.dataset.withTax || 'NaN');
        var hint = card.querySelector('.hint');
        if(!hint || !isFinite(wt) || !isFinite(curPay) || curPay<=0) return;
        var delta = Math.round(curPay - wt);
        hint.classList.remove('good','bad','pulse');
        if(delta>0){ hint.textContent='Saves $'+Math.abs(delta).toLocaleString()+'/mo vs current'; hint.classList.add('good','pulse'); }
        else if(delta<0){ hint.textContent='+$'+Math.abs(delta).toLocaleString()+'/mo vs current'; hint.classList.add('bad','pulse'); }
        else { hint.textContent='Same monthly as current'; }
      });
    }catch(e){}
  }

  function restoreFromParams(){
    var p = readParams();
    if(p.family){ familySel.value = p.family; }
    populate(yearSel, yearsForFamily(familySel.value));
    if(p.year && Array.from(yearSel.options).some(function(o){return o.value===p.year;})){ yearSel.value = p.year; }
    collectTrimsForYear(); populateTrims('');
    if(p.trim && Array.from(trimSel.options).some(function(o){return o.value===p.trim;})){ trimSel.value = p.trim; }
    if(p.term && Array.from(termSel.options).some(function(o){return o.value===p.term;})){ termSel.value = p.term; }
    if(p.miles){ annualMilesSel.value = p.miles; }
    if(p.odo){ odoInput.value = p.odo; }
    pacpoToggle.checked = (p.pacpo === '1');
    hideNA.checked = (p.hidena === '1');
    if(p.msrp){ msrpInput.value = p.msrp; }
  }

  // --- Robust JSON loader ---
  function loadProgram(file, label){
    var target = file;
    if (file === '__current__') {
      target = programSel && programSel.value && programSel.value !== '__current__'
        ? programSel.value : 'porsche_residuals_all.json';
    }
    var isAbsolute = /^https?:\\/\\//i.test(target);
    var cacheBuster = (isAbsolute ? '' : (target.indexOf('?')>-1 ? '&' : '?')) + 't=' + Date.now();
    currentProgramLabel = label || target;

    return fetch(target + cacheBuster, {cache:'no-store'})
      .then(function(res){
        if(!res.ok) throw new Error('HTTP ' + res.status + ' loading ' + target);
        return res.json();
      })
      .then(function(j){
        data = j; window.__data = data;
        MONTHS = data.months || ["12","18","24","27","30","36","39","42","48","51","60"];
        PACPO = data.pacpo_bonus_percent || 2;
        sumProgram && (sumProgram.textContent = currentProgramLabel);
        initSelectors();
        restoreFromParams();
        applyLeaseDefaults(); // prefill estimator
        compute();
        updateShareURL();
      })
      .catch(function(e){
        alert('Could not load program JSON:\\n' + e.message);
      });
  }

  function applyLeaseDefaults(){
    // Prefill but keep editable
    if (!leaseMF.value) leaseMF.value = '0.00400';
    if (!leaseTax.value) leaseTax.value = '9.75';
    if (!leaseCapReduction.value) leaseCapReduction.value = '7500';
    if (!leaseFees.value) leaseFees.value = '1095';
  }

  // --- Sniffer ---
  function sniffRun(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var code = trimSel.value;
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;
    var entry = (yrKey && code && branch[yrKey] && branch[yrKey][code]) ? branch[yrKey][code] : null;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var PACPOpct = data.pacpo_bonus_percent || 2;
    var pacpoAdj = pacpoToggle.checked ? PACPOpct : 0;
    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\\s+/g,'')];
    var inceptionAdj = 0;
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    var termArray = MONTHS.slice();
    var mf = leaseMF.value ? Number(leaseMF.value) : NaN;
    var tax = leaseTax.value ? Number(leaseTax.value)/100 : 0;
    var cap = leaseCapCost.value ? Number(leaseCapCost.value) : 0;
    var capRed = leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    var fees = leaseFees.value ? Number(leaseFees.value) : 0;
    var msrp = msrpInput.value ? Number(msrpInput.value) : 0;

    var candidates = [];
    if(!entry){ document.getElementById('snifferList').innerHTML = ''; return; }

    termArray.forEach(function(t){
      var base = entry.residuals && entry.residuals[t];
      if(base == null) return;
      var aAdj = (parseInt(t,10) >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
      var finalRV = base + pacpoAdj + aAdj + inceptionAdj;

      // compute payment with same structure
      if(!isFinite(mf) || !isFinite(msrp) || !isFinite(cap)) return;
      var rvAmt = Math.round(msrp * (finalRV/100));
      var adjCap = (cap - (isFinite(capRed)?capRed:0) + (isFinite(fees)?fees:0));
      if(!isFinite(adjCap) || adjCap <= 0 || !isFinite(mf) || mf <= 0) return;
      var dep = (adjCap - rvAmt) / Number(t);
      var fin = (adjCap + rvAmt) * mf;
      var preTax = dep + fin;
      var withTax = preTax * (1 + (isFinite(tax) ? tax : 0));

      var lvi = computeLVI(finalRV, mf);
      candidates.push({ term: Number(t), withTax: Math.round(withTax), preTax: Math.round(preTax), rv: finalRV, lvi: lvi });
    });

    candidates.sort(function(a,b){
      if(sniffRank==='pay'){
        if(a.withTax !== b.withTax) return a.withTax - b.withTax; // cheaper first
        var al=(a.lvi==null? -Infinity:a.lvi), bl=(b.lvi==null? -Infinity:b.lvi); return bl - al; // then higher LVI
      } else {
        var al=(a.lvi==null? -Infinity:a.lvi), bl=(b.lvi==null? -Infinity:b.lvi);
        if(bl!==al) return bl - al; // higher LVI first
        return a.withTax - b.withTax;  // then cheaper payment
      }
    });
    var best = candidates.slice(0,6);
    var list = document.getElementById('snifferList');
    list.innerHTML = '';

    var curTxt = (leaseWithTax && leaseWithTax.textContent) ? leaseWithTax.textContent : '';
    var curPay = Number((curTxt||'').replace(/[^0-9.]/g,''));

    best.forEach(function(c){
      var div = document.createElement('div');
      div.className = 'sniffItem srow';
      div.style.cursor = 'pointer';
      div.dataset.withTax = String(c.withTax);
      div.dataset.term = String(c.term);

      var head = document.createElement('div');
      head.style.display='flex'; head.style.gap='10px'; head.style.alignItems='baseline';
      var hTerm = document.createElement('div'); hTerm.style.fontWeight='800'; hTerm.textContent = c.term + ' mo';
      var hPay = document.createElement('div'); hPay.className='muted'; hPay.textContent = '$' + c.withTax.toLocaleString() + ' /mo (w/ tax)';
      head.appendChild(hTerm); head.appendChild(hPay);

      var metrics = document.createElement('div');
      metrics.style.display='flex'; metrics.style.gap='16px'; metrics.style.flexWrap='wrap';
      var m1=document.createElement('div'); m1.className='muted'; m1.textContent='RV ' + c.rv.toFixed(2) + '%';
      var m2=document.createElement('div'); m2.className='muted'; m2.textContent='Pre-Tax $' + c.preTax.toLocaleString();
      var m3=document.createElement('div'); m3.className='muted'; m3.textContent=(c.lvi!=null?('LVI '+(c.lvi/1000).toFixed(1)+'k'):'LVI ‚Äî');
      metrics.appendChild(m1); metrics.appendChild(m2); metrics.appendChild(m3);

      div.appendChild(head);
      div.appendChild(metrics);

      if(isFinite(curPay) && curPay>0){
        var delta = Math.round(curPay - c.withTax);
        var save = document.createElement('div'); save.className='hint';
        if(delta>0){ save.textContent='Saves $'+Math.abs(delta).toLocaleString()+'/mo vs current'; save.classList.add('good','pulse'); }
        else if(delta<0){ save.textContent='+$'+Math.abs(delta).toLocaleString()+'/mo vs current'; save.classList.add('bad','pulse'); }
        else { save.textContent='Same monthly as current'; }
        div.appendChild(save);
      }

      div.addEventListener('click', function(){
        if (leaseTerm){ leaseTerm.value = String(c.term); leaseTermDirty = true; }
        document.getElementById('leaseCard').scrollIntoView({behavior:'smooth', block:'start'});
        leaseCompute();
        updateSnifferHints();
      });

      list.appendChild(div);
    });

    var note = (sniffRank==='pay') ? 'Ranks by With-Tax payment first, then Value Index (LVI)' : 'Ranks by Value Index (LVI) first, then With-Tax payment';
    if(rankNote) rankNote.textContent = note;
    var sum = document.getElementById('sniffSummary');
    if(sum) sum.textContent = 'Showing best 6 terms (final RV%, same structure)';
  }

  // --- Listeners ---
  programSel.addEventListener('change', function(){
    var opt = programSel.options[programSel.selectedIndex];
    loadProgram(programSel.value, opt ? opt.textContent.replace(/^Program:\\s*/,'') : null);
  });
  jumpSummaryBtn.addEventListener('click', function(){
    var el = document.getElementById('summaryBox');
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); el.classList.add('success-flash'); setTimeout(function(){ el.classList.remove('success-flash'); }, 600); }
  });
  familySel.addEventListener('change', function(){ populate(yearSel, yearsForFamily(familySel.value)); collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  yearSel.addEventListener('change', function(){ collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  trimSearch.addEventListener('input', function(){ populateTrims(trimSearch.value); compute(); });
  trimSel.addEventListener('change', compute);
  termSel.addEventListener('change', compute);
  pacpoToggle.addEventListener('change', compute);
  hideNA.addEventListener('change', compute);
  annualMilesSel.addEventListener('change', compute);
  odoInput.addEventListener('input', compute);
  msrpInput.addEventListener('input', compute);

  copyBtn.addEventListener('click', function(){
    var parts = [
      'Program: ' + (sumProgram ? sumProgram.textContent : '‚Äî'),
      'Year: ' + sumYear.textContent,
      'Family: ' + sumFamily.textContent,
      'Trim: ' + sumTrim.textContent,
      'Term: ' + sumTerm.textContent,
      'Miles/Year: ' + sumMilesYear.textContent,
      'Odometer: ' + sumOdo.textContent,
      (sumMsrp ? ('MSRP: ' + sumMsrp.textContent) : null),
      'Final: ' + sumFinal.textContent,
      'MSRP √ó RV%: ' + sumTrue.textContent,
      'LVI: ' + (sumLvi ? sumLvi.textContent : '‚Äî')
    ].filter(Boolean);
    var text = parts.join(' | ');
    navigator.clipboard.writeText(text).then(function(){
      var old = copyBtn.innerHTML; copyBtn.innerHTML = '‚úÖ Copied!'; copyBtn.classList.add('success-flash');
      setTimeout(function(){ copyBtn.innerHTML = old; copyBtn.classList.remove('success-flash'); }, 1500);
    });
  });

  exportCsvBtn.addEventListener('click', exportVisibleCSV);
  printBtn.addEventListener('click', printSummary);
  validateBtn.addEventListener('click', validateJSON);
  closeValBtn && closeValBtn.addEventListener('click', function(){ validatorCard.style.display='none'; });

  leaseCapCost.addEventListener('input', function(){ leaseCompute(); updateSnifferHints(); });
  leaseMF.addEventListener('input', function(){ leaseCompute(); updateSnifferHints(); compute(); });
  leaseTax.addEventListener('input', function(){ leaseCompute(); updateSnifferHints(); });
  leaseCapReduction.addEventListener('input', function(){ leaseCompute(); updateSnifferHints(); });
  leaseFees.addEventListener('input', function(){ leaseCompute(); updateSnifferHints(); });
  leaseTerm.addEventListener('input', function(){ leaseTermDirty = true; leaseCompute(); updateSnifferHints(); });

  // Pill toggle for ranking
  function updateRankPills(){
    if(rankNote) rankNote.textContent = (sniffRank==='pay') ? 'Ranks by With-Tax payment first, then With-Tax payment' : 'Ranks by Value Index (LVI) first, then With-Tax payment';
    if(pillLVI && pillPAY){
      if(sniffRank==='pay'){ pillPAY.style.opacity='1'; pillLVI.style.opacity='.7'; }
      else { pillLVI.style.opacity='1'; pillPAY.style.opacity='.7'; }
    }
  }
  pillLVI && pillLVI.addEventListener('click', function(){ sniffRank='lvi'; localStorage.setItem('sniffRank','lvi'); updateRankPills(); sniffRun(); });
  pillPAY && pillPAY.addEventListener('click', function(){ sniffRank='pay'; localStorage.setItem('sniffRank','pay'); updateRankPills(); sniffRun(); });
  updateRankPills();

  // --- Boot: honor ?data= or selected option ---
  var params = new URLSearchParams(location.search);
  var paramData = params.get('data');
  var initialProgram = (paramData && paramData.trim()) || programSel.value || 'porsche_residuals_all.json';
  // Align UI to program option if present
  for (var i=0;i<programSel.options.length;i++){
    if (programSel.options[i].value === initialProgram) { programSel.selectedIndex = i; break; }
  }
  var opt = programSel.options[programSel.selectedIndex];
  loadProgram(initialProgram, opt ? opt.textContent.replace(/^Program:\\s*/,'') : null);
})();
</script>

</body>
</html>
